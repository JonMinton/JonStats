<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>JonStats - Time Series</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">JonStats</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-main-course-statistical-inference-and-simulation" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Main Course: Statistical Inference and Simulation</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-main-course-statistical-inference-and-simulation">    
        <li>
    <a class="dropdown-item" href="../../../pages/main-course/intro-to-glms/index.html" rel="" target="">
 <span class="dropdown-text">(1) Intro to GLMs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/main-course/likelihood-and-simulation-theory/index.html" rel="" target="">
 <span class="dropdown-text">(2) Likelihood and Simulation Theory</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/main-course/complete-simulation-example/index.html" rel="" target="">
 <span class="dropdown-text">(3) Complete Simulation Example</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-supplementary-courses" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Supplementary Courses</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-supplementary-courses">    
        <li>
    <a class="dropdown-item" href="../../../pages/extra-courses/causal-inference/index.html" rel="" target="">
 <span class="dropdown-text">Causal Inference</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../pages/extra-courses/time-series/index.html" rel="" target="">
 <span class="dropdown-text">Time Series</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools ms-auto">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../pages/extra-courses/time-series/index.html">Time Series</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../pages/extra-courses/causal-inference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Causal Inference</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../pages/extra-courses/time-series/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Time Series</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#is-time-series-an-exception-that-proves-the-rule" id="toc-is-time-series-an-exception-that-proves-the-rule" class="nav-link active" data-scroll-target="#is-time-series-an-exception-that-proves-the-rule">Is Time Series an Exception That Proves The Rule?</a></li>
  <li><a href="#autoregression" id="toc-autoregression" class="nav-link" data-scroll-target="#autoregression">Autoregression</a>
  <ul class="collapse">
  <li><a href="#summing-up" id="toc-summing-up" class="nav-link" data-scroll-target="#summing-up">Summing up</a></li>
  </ul></li>
  <li><a href="#integration" id="toc-integration" class="nav-link" data-scroll-target="#integration">Integration</a>
  <ul class="collapse">
  <li><a href="#why-is-integration-called-integration-not-differencing" id="toc-why-is-integration-called-integration-not-differencing" class="nav-link" data-scroll-target="#why-is-integration-called-integration-not-differencing">Why is integration called integration not differencing?</a></li>
  <li><a href="#summing-up-1" id="toc-summing-up-1" class="nav-link" data-scroll-target="#summing-up-1">Summing up</a></li>
  </ul></li>
  <li><a href="#the-moving-average-model-in-context-of-arima" id="toc-the-moving-average-model-in-context-of-arima" class="nav-link" data-scroll-target="#the-moving-average-model-in-context-of-arima">The Moving Average Model in context of ARIMA</a>
  <ul class="collapse">
  <li><a href="#the-sound-of-a-moving-average" id="toc-the-sound-of-a-moving-average" class="nav-link" data-scroll-target="#the-sound-of-a-moving-average">The sound of a Moving Average</a></li>
  </ul></li>
  <li><a href="#the-moving-average-equation" id="toc-the-moving-average-equation" class="nav-link" data-scroll-target="#the-moving-average-equation">The moving average equation</a>
  <ul class="collapse">
  <li><a href="#autoregression-and-moving-average-the-long-and-the-short-of-it" id="toc-autoregression-and-moving-average-the-long-and-the-short-of-it" class="nav-link" data-scroll-target="#autoregression-and-moving-average-the-long-and-the-short-of-it">Autoregression and moving average: the long and the short of it</a></li>
  <li><a href="#concluding-remarks" id="toc-concluding-remarks" class="nav-link" data-scroll-target="#concluding-remarks">Concluding remarks</a></li>
  </ul></li>
  <li><a href="#full-arima-examples" id="toc-full-arima-examples" class="nav-link" data-scroll-target="#full-arima-examples">Full ARIMA Examples</a>
  <ul class="collapse">
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#dataset-used-airmiles" id="toc-dataset-used-airmiles" class="nav-link" data-scroll-target="#dataset-used-airmiles">Dataset used: Airmiles</a></li>
  <li><a href="#visual-inspection-of-airmiles" id="toc-visual-inspection-of-airmiles" class="nav-link" data-scroll-target="#visual-inspection-of-airmiles">Visual inspection of <code>airmiles</code></a></li>
  <li><a href="#arima-fitting-for-airmiles" id="toc-arima-fitting-for-airmiles" class="nav-link" data-scroll-target="#arima-fitting-for-airmiles">ARIMA fitting for airmiles</a></li>
  <li><a href="#arima-modelling-with-an-additional-transformation." id="toc-arima-modelling-with-an-additional-transformation." class="nav-link" data-scroll-target="#arima-modelling-with-an-additional-transformation.">ARIMA modelling with an additional transformation.</a></li>
  <li><a href="#comparing-model-specifications" id="toc-comparing-model-specifications" class="nav-link" data-scroll-target="#comparing-model-specifications">Comparing model specifications</a></li>
  <li><a href="#discussion-and-coming-up" id="toc-discussion-and-coming-up" class="nav-link" data-scroll-target="#discussion-and-coming-up">Discussion and coming up</a></li>
  </ul></li>
  <li><a href="#seasonal-time-series" id="toc-seasonal-time-series" class="nav-link" data-scroll-target="#seasonal-time-series">Seasonal Time Series</a>
  <ul class="collapse">
  <li><a href="#an-example-dataset" id="toc-an-example-dataset" class="nav-link" data-scroll-target="#an-example-dataset">An example dataset</a></li>
  <li><a href="#approach-one-reannualise" id="toc-approach-one-reannualise" class="nav-link" data-scroll-target="#approach-one-reannualise">Approach one: reannualise</a></li>
  <li><a href="#approach-two-seasonal-composition" id="toc-approach-two-seasonal-composition" class="nav-link" data-scroll-target="#approach-two-seasonal-composition">Approach Two: Seasonal Composition</a></li>
  <li><a href="#approach-three-sarima" id="toc-approach-three-sarima" class="nav-link" data-scroll-target="#approach-three-sarima">Approach Three: SARIMA</a></li>
  <li><a href="#summing-up-2" id="toc-summing-up-2" class="nav-link" data-scroll-target="#summing-up-2">Summing up</a></li>
  </ul></li>
  <li><a href="#vector-autoregression-var" id="toc-vector-autoregression-var" class="nav-link" data-scroll-target="#vector-autoregression-var">Vector Autoregression (VAR)</a>
  <ul class="collapse">
  <li><a href="#model-family-tree" id="toc-model-family-tree" class="nav-link" data-scroll-target="#model-family-tree">Model family tree</a></li>
  <li><a href="#so-what-is-a-multivariate-model" id="toc-so-what-is-a-multivariate-model" class="nav-link" data-scroll-target="#so-what-is-a-multivariate-model">So what is a multivariate model?</a></li>
  <li><a href="#vector-autoregression" id="toc-vector-autoregression" class="nav-link" data-scroll-target="#vector-autoregression">Vector Autoregression</a></li>
  <li><a href="#example-and-application-in-r" id="toc-example-and-application-in-r" class="nav-link" data-scroll-target="#example-and-application-in-r">Example and application in R</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul></li>
  <li><a href="#whats-missing" id="toc-whats-missing" class="nav-link" data-scroll-target="#whats-missing">What’s missing?</a>
  <ul class="collapse">
  <li><a href="#state-space-models-and-ets" id="toc-state-space-models-and-ets" class="nav-link" data-scroll-target="#state-space-models-and-ets">State Space Models and ETS</a></li>
  <li><a href="#demographic-forecasting-models" id="toc-demographic-forecasting-models" class="nav-link" data-scroll-target="#demographic-forecasting-models">Demographic forecasting models</a></li>
  <li><a href="#summing-up-3" id="toc-summing-up-3" class="nav-link" data-scroll-target="#summing-up-3">Summing up</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Time Series</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="is-time-series-an-exception-that-proves-the-rule" class="level2">
<h2 class="anchored" data-anchor-id="is-time-series-an-exception-that-proves-the-rule">Is Time Series an Exception That Proves The Rule?</h2>
<p><a href="../../../pages/main-course/intro-to-glms/index.html">In the main course</a> I’ve returned many times to the same ‘mother formula’ for a generalised linear model:</p>
<p><strong>Stochastic Component</strong></p>
<p><span class="math display">\[
Y_i \sim f(\theta_i, \alpha)
\]</span></p>
<p><strong>Systematic Component</strong></p>
<p><span class="math display">\[
\theta_i = g(X_i, \beta)
\]</span></p>
<p>So, we have a system that takes a series of inputs, <span class="math inline">\(X\)</span>, and returns an output, <span class="math inline">\(Y\)</span>, and we have two sets of parameters, <span class="math inline">\(\beta\)</span> in <span class="math inline">\(g(.)\)</span> and <span class="math inline">\(\alpha\)</span> in <span class="math inline">\(f(.)\)</span>, which are calibrated based on the discrepancy between what the model predicted output <span class="math inline">\(Y\)</span> and the observed output <span class="math inline">\(y\)</span>.</p>
<p>There are two important things to note: Firstly, that the choice of parts of the data go into the inputs <span class="math inline">\(X\)</span> and the output(s) <span class="math inline">\(Y\)</span> is ultimately our own. A statistical model won’t ‘know’ when we’re trying to predict the cause of something based on its effect, for example. Secondly, that although the choice of input and output for the model are ultimately arbitrary, <em>they cannot be the same</em>. i.e., we cannot do this:</p>
<p><span class="math display">\[
Y_i \sim f(\theta_i, \alpha)
\]</span></p>
<p><span class="math display">\[
\theta_i = g(Y_i, \beta)
\]</span></p>
<p>This would be the model calibration equivalent of telling a dog to chase, or a snake to eat, its own tail. It doesn’t make sense, and so the parameter values involved cannot be calculated.</p>
<p>For time series data, however, this might appear to be a fundamental problem, given our observations may comprise only of ‘outcomes’, which look like they should be in the output slot of the formulae, rather than determinants, which look like they should be in the input slot of the formulae. i.e.&nbsp;we might have data that looks as follows:</p>
<table class="table">
<thead>
<tr class="header">
<th><span class="math inline">\(i\)</span></th>
<th><span class="math inline">\(Y_{T-2}\)</span></th>
<th><span class="math inline">\(Y_{T-1}\)</span></th>
<th><span class="math inline">\(Y_{T}\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>4.8</td>
<td>5.0</td>
<td>4.9</td>
</tr>
<tr class="even">
<td>2</td>
<td>3.7</td>
<td>4.1</td>
<td>4.3</td>
</tr>
<tr class="odd">
<td>3</td>
<td>4.3</td>
<td>4.1</td>
<td>4.3</td>
</tr>
</tbody>
</table>
<p>Where <span class="math inline">\(T\)</span> indicates an index time period, and <span class="math inline">\(T-k\)</span> a fixed difference in time ahead of or behind the index time period. For example, <span class="math inline">\(T\)</span> might be 2019, <span class="math inline">\(T-1\)</span> might be 2018, <span class="math inline">\(T-2\)</span> might be 2017, and so on.</p>
<p>Additionally, for some time series data, the dataset will be much more wide than long, perhaps with just a single observed unit, observed at many different time points:</p>
<table class="table">
<colgroup>
<col style="width: 14%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 18%">
<col style="width: 22%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th><span class="math inline">\(i\)</span></th>
<th><span class="math inline">\(Y_{T-5}\)</span></th>
<th><span class="math inline">\(Y_{T-4}\)</span></th>
<th><span class="math inline">\(Y_{T-3}\)</span></th>
<th><span class="math inline">\(Y_{T-2}\)</span></th>
<th><span class="math inline">\(Y_{T-1}\)</span></th>
<th><span class="math inline">\(Y_{T}\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>3.9</td>
<td>5.1</td>
<td>4.6</td>
<td>4.8</td>
<td>5.0</td>
<td>4.9</td>
</tr>
</tbody>
</table>
<p>Given all values are ‘outcomes’, where’s the candidate for an ‘input’ to the model, i.e.&nbsp;something we should consider putting into <span class="math inline">\(X\)</span>?</p>
<p>Doesn’t the lack of an <span class="math inline">\(X\)</span> mean time series is an exception to the ‘rule’ about what a statistical model looks like, and so everything we’ve learned so far is no longer relevant?</p>
<p>The answer to the second question is <em>no</em>. Let’s look at why.</p>
</section>
<section id="autoregression" class="level2">
<h2 class="anchored" data-anchor-id="autoregression">Autoregression</h2>
<p>Instead of looking at the data in the wide format above, let’s instead rearrange it in long format, so the time variable is indexed in its own column:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>i, <span class="sc">~</span>t, <span class="sc">~</span>y,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">2008</span>, <span class="fl">3.9</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">2009</span>, <span class="fl">5.1</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">2010</span>, <span class="fl">4.6</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">2011</span>, <span class="fl">4.8</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">2012</span>, <span class="fl">5.0</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">2013</span>, <span class="fl">4.9</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
      i     t     y
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1  2008   3.9
2     1  2009   5.1
3     1  2010   4.6
4     1  2011   4.8
5     1  2012   5  
6     1  2013   4.9</code></pre>
</div>
</div>
<p>As there’s only one type of observational unit, <span class="math inline">\(i=1\)</span> in all cases, there’s no variation in this variable, so it can’t provide any information in a model. Let’s look at the series and think some more:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(t, y)) <span class="sc">+</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We could, of course, regress the outcome against time:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(t, y)) <span class="sc">+</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Is this reasonable? It depends on the context. We obviously don’t have that many observations, but the regression slope appears to have a positive gradient, meaning values projected into the future will likely be higher than the observed values, and values projected into the past will likely have lower than the observed values.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(t, y)) <span class="sc">+</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">2000</span>, <span class="dv">2020</span>)) <span class="sc">+</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">fullrange =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Maybe this kind of extrapolation is reasonable. Maybe it’s not. As usual it depends on context. Although it’s a model including time as a predictor, it’s not actually a time series model. Here’s an example of a time series model:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>lm_ts_ar0 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> df)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm_ts_ar0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ 1, data = df)

Residuals:
       1        2        3        4        5        6 
-0.81667  0.38333 -0.11667  0.08333  0.28333  0.18333 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   4.7167     0.1778   26.53 1.42e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.4355 on 5 degrees of freedom</code></pre>
</div>
</div>
<p>This is an example of a time series model, even though it doesn’t have a time component on the predictor side. In fact, it doesn’t have anything as a predictor. Its formula is <code>y ~ 1</code>, meaning there’s just an intercept term. It’s saying “assume new values are just like old values: all just drawn from the same normal distribution”.</p>
<p>I called this model <code>ar0</code>. Why? Well, let’s look at the following:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>lm_ts_ar1 <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">y_lag1 =</span> <span class="fu">lag</span>(y, <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lm</span>(y <span class="sc">~</span> y_lag1, <span class="at">data =</span> .)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm_ts_ar1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ y_lag1, data = .)

Residuals:
        2         3         4         5         6 
-0.005066 -0.158811 -0.103084  0.154626  0.112335 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept)   6.2304     0.7661   8.132  0.00389 **
y_lag1       -0.2885     0.1630  -1.770  0.17489   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.1554 on 3 degrees of freedom
  (1 observation deleted due to missingness)
Multiple R-squared:  0.5108,    Adjusted R-squared:  0.3477 
F-statistic: 3.133 on 1 and 3 DF,  p-value: 0.1749</code></pre>
</div>
</div>
<p>For this model, I included one new predictor: <code>y_lag1</code>. For this, I created a new column in the dataset:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">y_lag1 =</span> <span class="fu">lag</span>(y, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
      i     t     y y_lag1
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     1  2008   3.9   NA  
2     1  2009   5.1    3.9
3     1  2010   4.6    5.1
4     1  2011   4.8    4.6
5     1  2012   5      4.8
6     1  2013   4.9    5  </code></pre>
</div>
</div>
<p>The <code>lag()</code> operator takes a column and a lag term parameter, in this case <code>1</code> <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. For each row, the value of <code>y_lag1</code> is the value of <code>y</code> one row above. <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>The first simple model was called AR0, and the second AR1. So what does AR stand for?</p>
<p>If you’re paying attention to the section title, you already have the answer. It means <strong>autoregressive</strong>. The AR1 model is the simplest type of autoregressive model, by which I don’t mean this is a type of regression model that formulates itself, but do mean it includes its own past states (at time T-1) as predictors of its current state (at time T).</p>
<p>And what does <span class="math inline">\(T\)</span> and <span class="math inline">\(T-1\)</span> refer to in the above? Well, for row 6 <span class="math inline">\(T\)</span> refers to <span class="math inline">\(t\)</span>, which is 2013; and so <span class="math inline">\(T-1\)</span> refers to 2012. But for row 5 <span class="math inline">\(T\)</span> refers to 2012, so <span class="math inline">\(T-1\)</span> refers to 2011. This continues back to row 2, where <span class="math inline">\(T\)</span> is 2009 so <span class="math inline">\(T-1\)</span> must be 2008. (The first row doesn’t have a value for <code>y_lag1</code>, so can’t be included in the regression).</p>
<p>Isn’t this a bit weird, however? After all, we only have one real observational unit, <span class="math inline">\(i\)</span>, but for the AR1 model we’re using values from this unit five times. Doesn’t this violate some kind of rule or expectation required for model outputs to be legitimate?</p>
<p>Well, it might. A common shorthand when describing the assumptions that we make when applying statistical models is <span class="math inline">\(IID\)</span>, which stands for <a href="https://en.wikipedia.org/wiki/Independent_and_identically_distributed_random_variables">‘independent and identically distributed’</a>. As with many unimaginative discussions of statistics, we can illustrate something that satifies both of these properties, <em>independent</em> and <em>identically distributed</em> by looking at some coin flips:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>uniform_values <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>coin_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">flip_number =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_head =</span> uniform_values <span class="sc">&gt;=</span> <span class="fl">0.5</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>coin_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   flip_number is_head
         &lt;int&gt; &lt;lgl&gt;  
 1           1 TRUE   
 2           2 FALSE  
 3           3 FALSE  
 4           4 FALSE  
 5           5 FALSE  
 6           6 TRUE   
 7           7 FALSE  
 8           8 TRUE   
 9           9 FALSE  
10          10 FALSE  </code></pre>
</div>
</div>
<p>The above series of coin flips is <em>identically distributed</em> because the order in which the flips occur doesn’t matter to the value generated. The dataframe could be permutated in any order and it wouldn’t matter to the data generation process at all. The series is <em>independent</em> because the probability of getting, say, a sequence of three heads is just the product of getting one head, three times, i.e.&nbsp;i.e.&nbsp;<span class="math inline">\(\frac{1}{2} \frac{1}{2} \frac{1}{2}\)</span> or <span class="math inline">\([\frac{1}{2}]^{3}\)</span>. Without going into too much detail, both of these assumptions are necessary to make in order for likelihood estimation, which relies on multiplying sequences of numbers <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> to ‘work’.</p>
<p>The central assumption and hope with an autoregressive model specification is that, <em>conditional</em> on the autoregressive terms being included on the predictor side of the model, the data <em>can</em> assumed to have been generated from an IID data generating process (DGP).</p>
<p>The intuition behind this is something like the following: say you wanted to know if I’ll have the flu tomorrow. It would obviously be useful to know if I have the flu today, because symptoms don’t change very quickly. <a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> Maybe it would also be good to know if I had the flu yesterday too, maybe even two days ago as well. But would it be good to know if I had the flu two weeks ago, or five weeks ago? Probably not. At some point, i.e.&nbsp;some number of lag terms from a given time, more historical data stops being informative. i.e., beyond a certain number of lag periods, the data series <em>can</em> be assumed to be IID (hopefully).</p>
<p>When building autoregressive models, it is common to look at a range of specifications, each including different numbers of lag terms. I.e. we can build a series of AR specification models as follows:</p>
<ul>
<li><code>AR(0)</code>: <span class="math inline">\(Y_T \sim 1\)</span></li>
<li><code>AR(1)</code>: <span class="math inline">\(Y_T \sim Y_{T-1}\)</span></li>
<li><code>AR(2)</code>: <span class="math inline">\(Y_T \sim Y_{T-1} + Y_{T-2}\)</span></li>
<li><code>AR(3)</code>: <span class="math inline">\(Y_T \sim Y_{T-1} + Y_{T-2} + Y_{T-3}\)</span></li>
</ul>
<p>And so on. Each successive AR(.) model contains more terms than the last, so is a more complicated and data hungry model than the previous one. We should already by this point in the series be familiar with standard approaches for trying to find the best trade off between model complexity and model fit. The above models are in a sense nested, so for example F-tests can be used to compare these models. Another approach, which ‘works’ for both nested and non-nested model specifications, is AIC, and indeed this is commonly used to select the ‘best’ number of autoregressive terms to include.</p>
<p>For future reference, the number of AR terms is commonly denoted with the letter ‘p’, meaning that if <code>p</code> is 3, for example, then we are talking about an <code>AR(3)</code> model specification.</p>
<section id="summing-up" class="level3">
<h3 class="anchored" data-anchor-id="summing-up">Summing up</h3>
<p>The other important thing to note is that autoregression is a way of fitting time series data within the two component ‘mother formulae’ at the start of this post (and many others), by operating on the systematic component of the model framework, <span class="math inline">\(g(.)\)</span>. At this stage, nothing unusual is happening with the stochastic component of the model framework <span class="math inline">\(f(.)\)</span>.</p>
<p>With autoregression, denoted by the formula shorthand <span class="math inline">\(AR(.)\)</span> and the parameter shorthand <span class="math inline">\(p\)</span>, we now have one of the three main tools in the modeller’s toolkit for handling time series data.</p>
</section>
</section>
<section id="integration" class="level2">
<h2 class="anchored" data-anchor-id="integration">Integration</h2>
<p>Consider the following time series data:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">8</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">30</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>intercept <span class="ot">&lt;-</span> <span class="fl">2.35</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fl">0.15</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> intercept <span class="sc">+</span> slope <span class="sc">*</span> t <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">31</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fl">0.2</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">t =</span> t,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(t, y)) <span class="sc">+</span> </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This time series data is an example of a <em>non-stationary</em> time series. This term means that its value drifts in a particular direction over time. In this case, upwards, meaning values towards the end of the series tend to be higher than values towards the start of the series.</p>
<p>What this drift means is that <em>the order of the observations matters</em>, i.e.&nbsp;if we looked at the same observations, but in a random order, we wouldn’t see something that looks similar to what we’re seeing here.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">rand_selection =</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">30</span>)) <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(rand_selection, y)) <span class="sc">+</span> </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As it’s clear the order of the sequence matters, the standard simplifying assumptions for statistical models of IID (independent and identically distributed) does not hold, so the extent to which observations from the same time series dataset can be treated like new pieces of information for the model is doubtful. We need a way of making the observations that go into the model (though not necessarily what we do with the model after fitting it) more similar to each other, so these observations <em>can</em> be treated as IID. How do we do this?</p>
<p>The answer is something that’s blindingly obvious in retrospect. We can <em>transform</em> the data that goes into the model by taking the <em>differences between consecutive values</em>. So, if the first ten values of our dataset look like this:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df, <span class="at">n=</span><span class="dv">10</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
       t     y
   &lt;int&gt; &lt;dbl&gt;
 1     0  2.33
 2     1  2.67
 3     2  2.56
 4     3  2.69
 5     4  3.10
 6     5  3.08
 7     6  3.22
 8     7  3.18
 9     8  2.95
10     9  3.58</code></pre>
</div>
</div>
<p>Then we can take the differences between consecutive values and get the following:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">diff_y =</span> y <span class="sc">-</span> <span class="fu">lag</span>(y, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(<span class="at">n=</span><span class="dv">11</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 3
       t     y  diff_y
   &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;
 1     0  2.33 NA     
 2     1  2.67  0.335 
 3     2  2.56 -0.111 
 4     3  2.69  0.133 
 5     4  3.10  0.407 
 6     5  3.08 -0.0188
 7     6  3.22  0.138 
 8     7  3.18 -0.0336
 9     8  2.95 -0.235 
10     9  3.58  0.634 
11    10  3.70  0.117 </code></pre>
</div>
</div>
<p>So, as with autoregression (AR), with integration we’ve arranged the data in order, then used the lag operator. The difference between the use of lagging as a tool for <code>AR</code>, and lagging as a tool for integration (<code>I</code>), is that, whereas for autoregression, we’re using lagging to construct one or more variables to use as predictor terms for the model, within integration we’re using lagging to construct new variables for use in either the response or the predictor sides of the model equation.</p>
<p>What does our differenced data look like?</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">diff_y =</span> y <span class="sc">-</span> <span class="fu">lag</span>(y, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(t, diff_y)) <span class="sc">+</span> </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In the above I’ve added a reference line at <code>y=0</code>. Note that the average of this series appears to be above the zero line. Let’s check this assumption:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>dy <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">diff_y =</span> y <span class="sc">-</span> <span class="fu">lag</span>(y, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(diff_y) </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"The mean dy is "</span>, <span class="fu">mean</span>(dy, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "The mean dy is 0.16"</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"The corresponding SE is "</span>, (<span class="fu">sd</span>(dy, <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(dy)<span class="sc">-</span><span class="dv">1</span>)) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "The corresponding SE is 0.06"</code></pre>
</div>
</div>
<p>This mean value of the differences values, <span class="math inline">\(dy\)</span>, is about 0.16. This is the <em>intercept</em> of the <em>differenced data</em>. As we made up the original data, we also know that its <em>slope</em> is 0.15, i.e.&nbsp;except for estimation uncertainty, the <em>intercept</em> of the differenced data is the <em>slope</em> of the original data. <a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<p>Importantly, when it comes to time series, whereas our original data were not stationary, our differenced data are. This means they are more likely to meet the IID conditions, including that the order of observations no longer really matters as to its value.</p>
<p>One way of demonstrating this is with a statistical <a href="https://royalsocietypublishing.org/doi/epdf/10.1098/rsta.2009.0120">identity parade</a>.</p>
<p>Here are nine versions of the undifferenced data, eight of which have been randomly shuffled. Can you tell which is the original, unshuffled data?</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">9</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>permute_randomly <span class="ot">&lt;-</span> <span class="cf">function</span>(id, df){</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">|&gt;</span> </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">sample</span>(y))</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>df_parade <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>]</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(id, permute_randomly, <span class="at">df =</span> df))</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>df_parade<span class="sc">$</span>data[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> df</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>df_parade <span class="sc">|&gt;</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(data) <span class="sc">|&gt;</span> </span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(t, y)) <span class="sc">+</span> </span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here it seems fairly obvious which dataset is the original, unshuffled version of the data, again illustrating that the original time series are not IID, and not a stationary series.</p>
<p>By contrast, let’s repeat the same exercise with the differenced data:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>d_df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(t) <span class="sc">|&gt;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">diff_y =</span> y <span class="sc">-</span> <span class="fu">lag</span>(y, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(t, <span class="at">y =</span> diff_y) <span class="sc">%&gt;%</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">complete.cases</span>(.))</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>diff_df_parade <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>]</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(id, permute_randomly, <span class="at">df =</span> d_df))</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>diff_df_parade<span class="sc">$</span>data[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> d_df</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>diff_df_parade <span class="sc">|&gt;</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(data) <span class="sc">|&gt;</span> </span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(t, y)) <span class="sc">+</span> </span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here it’s much less obvious which of the series is the original series, rather than a permuted/shuffled version of the same series. This should give some reassurance that, after differencing, the data are now IID.</p>
<section id="why-is-integration-called-integration-not-differencing" class="level3">
<h3 class="anchored" data-anchor-id="why-is-integration-called-integration-not-differencing">Why is integration called integration not differencing?</h3>
<p>In the above we have performed what in time series parlance would be called an <code>I(1)</code> operation, differencing the data once. But why is this referred to as integration, when we’re doing the opposite?</p>
<p>Well, when it comes to transforming the time series data into something with IID properties, we are differentiating rather than integrating. But the flip side of this is that, if using model outputs based on differenced data for forecasting, we have to sum up (i.e.&nbsp;<em>integrate</em>) the values we generate in the order in which we generate them. So, the model works on the differenced data, but model forecasts work by integrating the random variables generated by the model working on the differenced data.</p>
<p>Let’s explore what this means in practice. Let’s generate 10 new values from a model calibrated on the mean and standard deviation of the differenced data:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>new_draws <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>, </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(d_df<span class="sc">$</span>y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">sd</span>(d_df<span class="sc">$</span>y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>new_draws</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  0.053763359  0.638791031 -0.106726422  0.470132841 -0.084156880
 [6] -0.041865610  0.002496487  0.481433544 -0.082119365  0.086125038</code></pre>
</div>
</div>
<p>We can append these to the end of our differenced data to see how this forecast series compared with the observed series:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>max_t <span class="ot">&lt;-</span> <span class="fu">max</span>(d_df<span class="sc">$</span>t)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>forecast_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">t =</span> <span class="fu">seq</span>(<span class="at">from =</span> max_t<span class="sc">+</span><span class="dv">1</span>, <span class="at">to =</span> max_t <span class="sc">+</span> <span class="fu">length</span>(new_draws)),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> new_draws,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"forecast"</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>obs_forecast_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    d_df <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">'observed'</span>),</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    forecast_df</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>obs_forecast_df <span class="sc">|&gt;</span> </span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(t, y)) <span class="sc">+</span> </span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">shape =</span> type, <span class="at">colour =</span> type)) <span class="sc">+</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> type)) <span class="sc">+</span> </span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"observed"</span> <span class="ot">=</span> <span class="st">'solid'</span>, <span class="st">'forecast'</span> <span class="ot">=</span> <span class="st">'dashed'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So we can see that the forecast sequence of values looks quite similar to the differenced observations before it.</p>
<p>In order to use this for forecasting values, rather than differences, we therefore have to take the last observed value, and keep adding the consecutive forecast values.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>last_obs_y <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> <span class="fu">filter</span>(t <span class="sc">==</span> <span class="fu">max</span>(t)) <span class="sc">|&gt;</span> <span class="fu">pull</span>(y)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>accumulated_new_draws <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(new_draws)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>accumulated_new_draws</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0.05376336 0.69255439 0.58582797 1.05596081 0.97180393 0.92993832
 [7] 0.93243481 1.41386835 1.33174898 1.41787402</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>forecast_values <span class="ot">&lt;-</span> last_obs_y <span class="sc">+</span> accumulated_new_draws</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>forecast_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">t =</span> <span class="fu">seq</span>(<span class="at">from =</span> max_t<span class="sc">+</span><span class="dv">1</span>, <span class="at">to =</span> max_t <span class="sc">+</span> <span class="fu">length</span>(new_draws)),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> forecast_values,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"forecast"</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>obs_forecast_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    df <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">'observed'</span>),</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    forecast_df</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>obs_forecast_df <span class="sc">|&gt;</span> </span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(t, y)) <span class="sc">+</span> </span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">shape =</span> type, <span class="at">colour =</span> type)) <span class="sc">+</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> type)) <span class="sc">+</span> </span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"observed"</span> <span class="ot">=</span> <span class="st">'solid'</span>, <span class="st">'forecast'</span> <span class="ot">=</span> <span class="st">'dashed'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>So, after integrating (accumulating or summing up) the modelled differenced values, we now see the forecast values continuing the upwards trend observed in the original data.</p>
<p>Of course, there’s nothing special about the specific sequence of draws generated from the model. We could run the same exercise multiple times and each time get a different sequence of model draws, and so a different forecast path. Let’s see ten draws, for example:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>make_multiple_paths <span class="ot">&lt;-</span> <span class="cf">function</span>(path_length, n_reps, start_value, mu, sigma, start_t){</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    make_path <span class="ot">&lt;-</span> <span class="cf">function</span>(start_t, mu, sigma, path_length, start_value) {</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>        draws <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(path_length, <span class="at">mean =</span> mu, <span class="at">sd =</span> sigma)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        summed_values <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(draws)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        forecast_values <span class="ot">&lt;-</span> summed_values <span class="sc">+</span> start_value</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>        out <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">t =</span> <span class="fu">seq</span>(<span class="at">from =</span> start_t, <span class="at">to =</span> start_t <span class="sc">+</span> path_length <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> forecast_values</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(out)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    paths <span class="ot">&lt;-</span> <span class="fu">replicate</span>(</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>        n_reps, </span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">make_path</span>(</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>                    <span class="at">start_t =</span> start_t, </span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>                    <span class="at">mu =</span> mu, <span class="at">sigma =</span> sigma, <span class="at">path_length =</span> path_length, <span class="at">start_value =</span> start_value</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">apply</span>(<span class="dv">2</span>, as.data.frame)</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">rep_num =</span> <span class="dv">1</span><span class="sc">:</span>n_reps,</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> paths</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unnest</span>(data)</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(out)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>paths <span class="ot">&lt;-</span> <span class="fu">make_multiple_paths</span>(</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">path_length =</span> <span class="dv">10</span>, </span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_reps =</span> <span class="dv">10</span>, </span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu =</span> <span class="fu">mean</span>(d_df<span class="sc">$</span>y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> <span class="fu">sd</span>(d_df<span class="sc">$</span>y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_value =</span> last_obs_y, </span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_t =</span> <span class="fu">max</span>(d_df<span class="sc">$</span>t) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(t, y)) <span class="sc">+</span> </span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(t, y, <span class="at">group =</span> rep_num), <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">data =</span> paths, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">colour =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This gives a sense of the kinds of upwards-drifting walks are compatible with the amount of variation observed in the original data series. If we ran the experiment another 10 times, we would get another ten paths.</p>
<p>In fact, we could generate a much larger number of simulations, say 10,000, and then report the range of values within which (say) 50% or 90% of the values for each time period are contained:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>many_paths <span class="ot">&lt;-</span> <span class="fu">make_multiple_paths</span>(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">path_length =</span> <span class="dv">10</span>, </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_reps =</span> <span class="dv">10000</span>, </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu =</span> <span class="fu">mean</span>(d_df<span class="sc">$</span>y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma =</span> <span class="fu">sd</span>(d_df<span class="sc">$</span>y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_value =</span> last_obs_y, </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_t =</span> <span class="fu">max</span>(d_df<span class="sc">$</span>t) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>many_paths_summary <span class="ot">&lt;-</span> many_paths <span class="sc">|&gt;</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(t) <span class="sc">|&gt;</span> </span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">med =</span> <span class="fu">median</span>(y), </span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">lq =</span> <span class="fu">quantile</span>(y, <span class="at">probs =</span> <span class="fl">0.25</span>), <span class="at">uq =</span> <span class="fu">quantile</span>(y, <span class="at">probs =</span> <span class="fl">0.75</span>), <span class="at">l5 =</span> <span class="fu">quantile</span>(y, <span class="at">probs =</span> <span class="fl">0.05</span>), <span class="at">u5 =</span> <span class="fu">quantile</span>(y, <span class="at">probs =</span> <span class="fl">0.95</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(t, y)) <span class="sc">+</span> </span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(t, med), <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">data =</span> many_paths_summary, <span class="at">colour =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(t, <span class="at">ymin =</span> lq, <span class="at">ymax =</span> uq), </span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">data =</span> many_paths_summary,</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">colour =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.25</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(t, <span class="at">ymin =</span> l5, <span class="at">ymax =</span> u5),</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">data =</span> many_paths_summary,</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">colour =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.25</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>These produce the kinds of ‘fans of uncertainty’ we might be used to seeing from a time series forecast. Because of the large numbers of simulations run, the shape of the fans appear quite smooth, and close to the likely analytical solution.</p>
</section>
<section id="summing-up-1" class="level3">
<h3 class="anchored" data-anchor-id="summing-up-1">Summing up</h3>
<p>In this post we’ve explored the second of the three main tools in the most common time series analytical toolkit: Integration. We’ve differenced our data once, which in time series parlance is represented by the shorthand <code>d=1</code>. Then we’ve integrated estimates we’ve produced from a model after differencing to represent random paths projecting forward from the observed data into a more uncertain future. Doing this multiple times has allowed us to represent uncertainty about these projections, and the ways that uncertainty increases the further we move from the observed data.</p>
</section>
</section>
<section id="the-moving-average-model-in-context-of-arima" class="level2">
<h2 class="anchored" data-anchor-id="the-moving-average-model-in-context-of-arima">The Moving Average Model in context of ARIMA</h2>
<p>As with the post on autoregression, it’s worth returning to what I’ve been calling The Mother Model (a general way of thinking about statistical models), and how <code>AR</code> and <code>I</code> relate to it:</p>
<p><strong>Stochastic Component</strong></p>
<p><span class="math display">\[
Y_i \sim f(\theta_i, \alpha)
\]</span></p>
<p><strong>Systematic Component</strong></p>
<p><span class="math display">\[
\theta_i = g(X_i, \beta)
\]</span></p>
<p>To which we might also imagine adding a transformation or preprocessing step, <span class="math inline">\(h(.)\)</span> on the dataset <span class="math inline">\(D\)</span></p>
<p><span class="math display">\[
Z = h(D)
\]</span></p>
<p>The process of <strong>differencing</strong> the data is the transformation step employed most commonly in time series modelling. This changes the types of values that go into both the data <em>input</em> slot of the mother model, <span class="math inline">\(X\)</span>, and the <em>output</em> slot of the mother model, <span class="math inline">\(Y\)</span>. The type of data transformer, however, is <strong>deterministic</strong>, hence the use of the <span class="math inline">\(=\)</span> symbol. This means an inverse transform function, <span class="math inline">\(h^{-1}(.)\)</span> can be applied to the transformed data to convert it back to the original data:</p>
<p><span class="math display">\[
D = h^{-1}(Z)
\]</span></p>
<p>The process of <strong>integrating the differences</strong>, including a series of forecast values from the time series models, constitutes this inverse transform function in the context of time series modelling, as we saw in the <a href="../lms-are-glms-part-20/index.qmd">last post</a>, on integration.</p>
<p>Autoregression is a technique for working with either the untransformed data, <span class="math inline">\(D\)</span>, or the transformed data <span class="math inline">\(Z\)</span>, which operates on the <strong>systematic component</strong> of the mother model. For example, an <code>AR(3)</code> autoregressive model, working on data which have been differenced once (<span class="math inline">\(Z_t = Y_t - Y_{t-1}\)</span>), may look as follows:</p>
<p><span class="math display">\[
Z_t \sim N(\mu, \sigma^2)
\]</span> <span class="math display">\[
\mu = \beta_0 + \beta_1 Z_{t-1} + \beta_2 Z_{t-2} + \beta_3 Z_{t-3}
\]</span></p>
<p>Which more commonly will look like something like:</p>
<p><span class="math display">\[
Z_t =  \mu + \beta_1 Z_{t-1} + \beta_2 Z_{t-2} + \beta_3 Z_{t-3} + \epsilon
\]</span></p>
<p>Note that these two approaches, <code>AR</code> and <code>I</code>, have involved operating on the <strong>systematic component</strong> and the <strong>preprocessing step</strong>, respectively. This gives us a clue about how the Moving Average (<code>MA</code>) modelling strategy is fundamentally different. <strong>Whereas <code>AR</code> models work on the systematic component (<span class="math inline">\(g(.)\)</span>), MA models work on the stochastic component (<span class="math inline">\(f(.)\)</span>).</strong> The following table summarises the distinct roles each technique plays in the general time series modelling strategy:</p>
<table class="table">
<caption>AR, I, and MA in the context of ‘the Mother Model’</caption>
<colgroup>
<col style="width: 28%">
<col style="width: 41%">
<col style="width: 29%">
</colgroup>
<thead>
<tr class="header">
<th>Technique</th>
<th>Works on…</th>
<th>ARIMA letter shorthand</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Integration (<code>I</code>)</td>
<td>Data Preprocessing <span class="math inline">\(h(.)\)</span></td>
<td><code>d</code></td>
</tr>
<tr class="even">
<td>Autoregression (<code>AR</code>)</td>
<td>Systematic Component <span class="math inline">\(g(.)\)</span></td>
<td><code>p</code></td>
</tr>
<tr class="odd">
<td>Moving Average (<code>MA</code>)</td>
<td>Stochastic Component <span class="math inline">\(f(.)\)</span></td>
<td><code>q</code></td>
</tr>
</tbody>
</table>
<p>In the above, I’ve spoiled the ending! The Autoregressive (<code>AR</code>), Integration (<code>I</code>), and Moving Average (<code>MA</code>) strategies are commonly combined into a single model framework, called ARIMA. ARIMA is a framework for specifying a family of models, rather than a single model, which differ by the amount of differencing (<code>d</code>), or autoregression terms (<code>p</code>), or moving average terms (<code>q</code>) which the model contains.</p>
<p>Although in the table above, I’ve listed integration/differencing first, as it’s the data preprocessing step, the more conventional way of specifying an ARIMA model is in the order indicated in the acronym:</p>
<ul>
<li>AR: <code>p</code></li>
<li>I: <code>d</code></li>
<li>MA: <code>q</code></li>
</ul>
<p>This means ARIMA models are usually specified with a three value shorthand <code>ARIMA(p, d, q)</code>. For example:</p>
<ul>
<li><code>ARIMA(1, 1, 0)</code>: <code>AR(1)</code> with <code>I(1)</code> and <code>MA(0)</code></li>
<li><code>ARIMA(0, 2, 2)</code>: <code>AR(0)</code> with <code>I(2)</code> and <code>MA(2)</code></li>
<li><code>ARIMA(1, 1, 1)</code>: <code>AR(1)</code> with <code>I(1)</code> and <code>MA(1)</code></li>
</ul>
<p>Each of these models is fundamentally different. But each is a type of ARIMA model.</p>
<p>With this broader context, about how MA models fit into the broader ARIMA framework, let’s now look at the Moving Average model:</p>
<section id="the-sound-of-a-moving-average" class="level3">
<h3 class="anchored" data-anchor-id="the-sound-of-a-moving-average">The sound of a Moving Average</h3>
<p>The intuition of a <code>MA(q)</code> model is in some ways easier to develop by starting not with the model equations, but with the following image:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://m.media-amazon.com/images/I/91nliey9YoS._AC_SX679_.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Tibetan Singing Bowl</figcaption>
</figure>
</div>
<p>This is a Tibetan Singing Bowl, available from all good stockists (and <a href="https://www.amazon.co.uk/Meditation-Hammered-Mindfulness-Healing-balancing/dp/B08Y8HTSVL?th=1">Amazon</a>), whose product description includes:</p>
<ul>
<li><strong>Ergonomic Design</strong>: The 3 inch singing bowl comes with a wooden striker and hand-sewn cushion which flawlessly fits in your hand. The portability of this bowl makes it possible to carry it everywhere you go.</li>
<li><strong>Holistic Healing</strong> : Our singing bowls inherently produces a deep tone with rich quality. The resonance emanated from the bowl revitalizes and rejuvenates all the body, mind and spirit. It acts as a holistic healing tool for overall well-being.</li>
</ul>
<p>Notwithstanding the claims about health benefits and ergonomics, the bowl is something meant to be hit by a wooden striker, and once hit makes a sound. This sound sustains over time (‘sings’), but as time goes on the intensity decays. As a sound wave, this might look something like the following:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>A0 <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>decay_rate <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">12</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>periodicity <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>delay <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">t =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="at">by =</span> <span class="fl">0.001</span>)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">H_t =</span> <span class="fu">ifelse</span>(t <span class="sc">&lt;</span> delay, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">A_t =</span> A0 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>(decay_rate <span class="sc">*</span> (t <span class="sc">-</span> delay))),</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">c_t =</span> <span class="fu">cos</span>((<span class="dv">1</span><span class="sc">/</span>periodicity) <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> (t <span class="sc">-</span> delay)),</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">f_t =</span> H_t <span class="sc">*</span> A_t <span class="sc">*</span> c_t</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(t, f_t)) <span class="sc">+</span> </span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"f(t)"</span>,</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"t"</span>,</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Intensity over time"</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> delay, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">colour =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In this figure, the red dashed line indicates when the wooden striker strikes the bowl. Before this time, the bowl makes no sound. Directly after the strike, the bowl is loudest, and over time the intensity of the sound waves emanating from the bowl decays. The striker can to some extent determine the maximum amplitude of the bowl, whereas it’s largely likely to be the properties of the bowl itself which determines how quickly or slowly the sound decays over time.</p>
<p>How does this relate to the Moving Average model? Well, if we look at the Interpretation section of <a href="https://en.wikipedia.org/wiki/Moving-average_model">the moving average model wikipedia page</a>, we see the cryptic statement “The moving-average model is essentially a finite impulse response filter applied to white noise”. And if we then delve into the <a href="https://en.wikipedia.org/wiki/Finite_impulse_response">finite impulse response page</a> we get the definition “a finite impulse response (FIR) filter is a filter whose impulse response (or response to any finite length input) is of <em>finite</em> duration, because it settles to zero in finite time”. Finally, if we go one level deeper into the wikirabbit hole, and enter the <a href="https://en.wikipedia.org/wiki/Impulse_response">impulse response</a> page, we get the following definition:</p>
<blockquote class="blockquote">
<p>[The] <strong>impulse response</strong>, or <strong>impulse response function (IRF)</strong>, of a dynamic system is its output when presented with a brief input signal, called an impulse.</p>
</blockquote>
<p>In the singing bowl example, <em>the striker is the impulse, and the ‘singing’ of the bowl is its response</em>.</p>
</section>
</section>
<section id="the-moving-average-equation" class="level2">
<h2 class="anchored" data-anchor-id="the-moving-average-equation">The moving average equation</h2>
<p>Now, finally, let’s look at the general equation for a moving average model:</p>
<p><span class="math display">\[
X_t = \mu + \sum_{i=1}^{q} \theta_i \epsilon_{t-i} + \epsilon_t
\]</span></p>
<p>For a <code>MA(q=2)</code> model, for example, this would look like:</p>
<p><span class="math display">\[
X_t = \mu + \epsilon_t + \theta_1 \epsilon_{t-1} + \theta_2 \epsilon_{t-2}
\]</span></p>
<p>Here is something like the fundamental value or quality of the time series system. For the singing bowl, <span class="math inline">\(\mu = 0\)</span>, but it can take any value. <span class="math inline">\(\epsilon_t\)</span> is intended to capture something like a ‘shock’ or impulse <em>now</em> which would cause its manifested value to differ from its fundamental, <span class="math inline">\(\epsilon_{t-1}\)</span> a ‘shock’ or impulse one time unit ago, and <span class="math inline">\(\epsilon_{t-2}\)</span> a ‘shock’ or impulse two time units ago.</p>
<p>The values <span class="math inline">\(\theta_i\)</span> are similar to the way the intensity of the singing bowl’s sound decays over time. They are intended to represent <em>how much</em> influence past ‘shocks’, from various recent points in history, have on the present value manifested. Larger values of <span class="math inline">\(\theta\)</span> indicate past ‘shocks’ that have larger influence on the present value, and smaller <span class="math inline">\(\theta\)</span> values less influence.</p>
<section id="autoregression-and-moving-average-the-long-and-the-short-of-it" class="level3">
<h3 class="anchored" data-anchor-id="autoregression-and-moving-average-the-long-and-the-short-of-it">Autoregression and moving average: the long and the short of it</h3>
<p>Autoregressive and moving average models are intended to be complementary in their function in describing a time series system: whereas Autoregressive models allow for <strong>long term influence of history</strong>, which can change the fundamentals of the system, Moving Average models are intended to represent <strong>transient, short term disturbances</strong> to the system. For an AR model, the system evolves in response to its past states, and so to itself. For a MA model, the system, fundamentally, never changes. It’s just constantly being ‘shocked’ by external events.</p>
</section>
<section id="concluding-remarks" class="level3">
<h3 class="anchored" data-anchor-id="concluding-remarks">Concluding remarks</h3>
<p>So, that’s the basic intuition and idea of the Moving Average model. A system fundamentally never changes, but external things keep ‘happening’ to it, meaning it’s almost always different to its true, fundamental value. A boat at sea will fundamentally have a height of sea level. But locally sea level is always changing, waves from every direction, and various intensities, buffetting the boat up and down - above and below the fundamental sea level average at every moment.</p>
<p>And the ‘sound’ of a moving average model is almost invariably likely to be less sonorous than that of a singing bowl. Instead of a neat sine wave, each shock is a random draw from a noisemaker (typically the Normal distribution). In this sense a more accurate analogy might not be a singing bowl, but a guitar amplifier, with a constant hum, but also with dodgy connections, constantly getting moved and adjusted, with each adjustment causing a short belt of white noise to be emanated from the speaker. A moving average model is noise layered upon noise.</p>
</section>
</section>
<section id="full-arima-examples" class="level2">
<h2 class="anchored" data-anchor-id="full-arima-examples">Full ARIMA Examples</h2>
<p>The last three posts have covered three of the main techniques - <a href="../lms-are-glms-part-19/index.qmd">autoregression</a>, <a href="../lms-are-glms-part-20/index.qmd">integration</a>, and <a href="../lms-are-glms-part-21/index.qmd">moving average</a> modelling - which combine to form the ARIMA model framework for time series analysis.</p>
<p>We’ll now look at an example (or maybe two) showing how ARIMA models - including AR, I, and MA components - are fit and employed in practice.</p>
<section id="setup" class="level3">
<h3 class="anchored" data-anchor-id="setup">Setup</h3>
<p>For this post I’ll make use of R’s <a href="https://cran.r-project.org/web/packages/forecast/index.html">forecast</a> package.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="dataset-used-airmiles" class="level3">
<h3 class="anchored" data-anchor-id="dataset-used-airmiles">Dataset used: Airmiles</h3>
<p>The dataset I’m going to use is <code>airmiles</code>, an example dataset from the datasets package, which is included in most R sessions by default</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>airmiles</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Time Series:
Start = 1937 
End = 1960 
Frequency = 1 
 [1]   412   480   683  1052  1385  1418  1634  2178  3362  5948  6109  5981
[13]  6753  8003 10566 12528 14760 16769 19819 22362 25340 25343 29269 30514</code></pre>
</div>
</div>
<p>The first thing we notice with this dataset is that it is not in the kind of tabular format we may be used to. Let’s see what class the dataset is:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(airmiles)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ts"</code></pre>
</div>
</div>
<p>The dataset is of class <code>ts</code>, which stands for time series. A <code>ts</code> data object is basically a numeric vector with various additional pieces of metadata attached. We can see these metadata fields are start date, end date, and frequency. The documentation for <code>ts</code> indicates that if frequency is 1, then the data are annual. As the series are at fixed intervals, with the start date and frequency specified, along with the length of the numeric vector, the time period associated with each value in the series can be inferred.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
</section>
<section id="visual-inspection-of-airmiles" class="level3">
<h3 class="anchored" data-anchor-id="visual-inspection-of-airmiles">Visual inspection of <code>airmiles</code></h3>
<p>We can look at the data using the base graphics plot function:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(airmiles)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see this dataset is far from stationary, being much higher towards the end of the series than at the start. This implies we should consider differencing the data to make it stationery. We can use the <code>diff()</code> function for this:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">diff</span>(airmiles))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This differenced series still doesn’t look like IID data. Remember that differencing is just one of many kinds of transformation (data pre-processing) we could consider. Also we can difference more than once.</p>
<p>As there cannot be negative airmiles, and the series looks exponential since the start of the series, we can can consider using a log transform:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">log</span>(airmiles))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here the data look closer to a straight line. Differencing the data now should help us get to something closer to stationary:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">diff</span>(<span class="fu">log</span>(airmiles)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Maybe we should also look at differencing the data twice:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">diff</span>(<span class="fu">log</span>(airmiles), <span class="at">differences =</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Maybe</strong> this is closer to the kind of stationary series that ARIMA works best with?</p>
</section>
<section id="arima-fitting-for-airmiles" class="level3">
<h3 class="anchored" data-anchor-id="arima-fitting-for-airmiles">ARIMA fitting for airmiles</h3>
<p>The visual inspection above suggested the dataset definitely needs at least one differencing term applied to it, and might need two; and might also benefit from being pre-transformed by being logged. With the <code>forecast</code> package, we can pass the series to the <code>auto.arima()</code> function, which will use an algorithm to attempt to identify the best combination of <code>p</code>, <code>d</code> and <code>q</code> terms to use. We can start by asking <code>auto.arima()</code> to determine the best ARIMA specification if the only transformation allowed is that of differencing the data, setting the <code>trace</code> argument to <code>TRUE</code> to learn more about which model specifications the algorithm has considered:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>best_arima_nolambda <span class="ot">&lt;-</span> <span class="fu">auto.arima</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> airmiles, </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">trace =</span> <span class="cn">TRUE</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
 ARIMA(2,2,2)                    : Inf
 ARIMA(0,2,0)                    : 384.231
 ARIMA(1,2,0)                    : 375.735
 ARIMA(0,2,1)                    : 375.3
 ARIMA(1,2,1)                    : 376.9756
 ARIMA(0,2,2)                    : 377.1793
 ARIMA(1,2,2)                    : Inf

 Best model: ARIMA(0,2,1)                    </code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(best_arima_nolambda)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Series: airmiles 
ARIMA(0,2,1) 

Coefficients:
          ma1
      -0.7031
s.e.   0.1273

sigma^2 = 1234546:  log likelihood = -185.33
AIC=374.67   AICc=375.3   BIC=376.85

Training set error measures:
                   ME    RMSE      MAE      MPE     MAPE      MASE       ACF1
Training set 268.7263 1039.34 758.5374 4.777142 10.02628 0.5746874 -0.2848601</code></pre>
</div>
</div>
<p>We can see from the trace that a range of ARIMA specifications were considered, starting with the ARIMA(2,2,2). The selection algorithm used is detailed <a href="https://otexts.com/fpp2/arima-r.html">here</a>, and employs a variation of AIC, called ‘corrected AIC’ or AICc, in order to compare the model specifications.</p>
<p>The algorithm arrives at ARIMA(0, 2, 1) as the preferred specification. That is: no autorgression (p=0), twice differenced (d=2), and with one moving average term (MA=1).</p>
<p>The Forecasting book linked to above also has a recommended <a href="https://otexts.com/fpp2/arima-r.html#modelling-procedure">modelling procedure for ARIMA specifications</a>, and cautions that the <code>auto.arima()</code> function only performs part of this proceudure. In particular, it recommends looking at the residuals</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">checkresiduals</span>(best_arima_nolambda)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(0,2,1)
Q* = 4.7529, df = 4, p-value = 0.3136

Model df: 1.   Total lags used: 5</code></pre>
</div>
</div>
<p>The three plots show the model residuals as a function of time (top), the distribution of residuals (bottom right), and the auto-correlation function, ACF (bottom-left), which indicates how the errors at different lags are correlated with each other. It also returns a test score, where <em>high P-values</em> (substantially above <code>0.05</code>) should be considered evidence that the residuals appear like white noise, and so (something like) no further substantial systematic information in the data exists to be represented in the model.</p>
<p>In this case, the test statistic p-value is 0.31, which should be reassuring as to the appropriateness of the model specification identified.</p>
<p>Finally, we can use this model to forecast a given number of periods ahead. Let’s take this data to the 1990s, even though this is a dangerously long projection.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>best_arima_nolambda <span class="sc">|&gt;</span> <span class="fu">forecast</span>(<span class="at">h=</span><span class="dv">35</span>) <span class="sc">|&gt;</span> <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The central projection (dark blue line) is almost linear, but the projection intervals are wide and growing, and include projection scenarios where the number of flights in the 1990s are somewhat lower than those in the 1960s. These wide intervals should be considered a feature rather than a bug with the approach, as the further into the future we project, the more uncertain we should become.</p>
</section>
<section id="arima-modelling-with-an-additional-transformation." class="level3">
<h3 class="anchored" data-anchor-id="arima-modelling-with-an-additional-transformation.">ARIMA modelling with an additional transformation.</h3>
<p>Another option to consider within the <code>auto.arima()</code> function is to allow another parameter to be estimated. This is known as the <code>lambda</code> parameter and represents an additional possible transformation of the data <em>before</em> the differencing step. This <code>lambda</code> parameter is used as part of a <a href="https://otexts.com/fpp2/transformations.html#mathematical-transformations">Box-Cox Transformation</a>, intended to stabilise the variance of the series. If the <code>lambda</code> parameter is <code>0</code>, then this becomes equivalent to logging the data. We can allow <code>auto.arima</code> to select a Box-Cox Transformation by setting the parameter <code>lambda = "auto"</code></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>best_arima_lambda <span class="ot">&lt;-</span> <span class="fu">auto.arima</span>(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> airmiles, </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">trace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> <span class="st">"auto"</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
 ARIMA(2,1,2) with drift         : Inf
 ARIMA(0,1,0) with drift         : 190.0459
 ARIMA(1,1,0) with drift         : 192.1875
 ARIMA(0,1,1) with drift         : 192.1483
 ARIMA(0,1,0)                    : 212.0759
 ARIMA(1,1,1) with drift         : 195.1062

 Best model: ARIMA(0,1,0) with drift         </code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(best_arima_lambda)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Series: airmiles 
ARIMA(0,1,0) with drift 
Box Cox transformation: lambda= 0.5375432 

Coefficients:
        drift
      18.7614
s.e.   2.8427

sigma^2 = 194.3:  log likelihood = -92.72
AIC=189.45   AICc=190.05   BIC=191.72

Training set error measures:
                   ME     RMSE      MAE       MPE     MAPE      MASE      ACF1
Training set 123.1317 934.6956 724.6794 -5.484572 12.91378 0.5490357 -0.169863</code></pre>
</div>
</div>
<p>In this case, a <code>lambda</code> value of about <code>0.54</code> has been identified, and a different ARIMA model specification selected. This specification is listed as ARIMA(0,1,0) <em>with drift</em>. This <em>with drift</em> term means the series are recognised as non-stationary, but where (after transformation) there is an average (in this case) constant amount upwards drift in the values as we progress through the series. <a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> Let’s check the residuals for this model:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">checkresiduals</span>(best_arima_lambda)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(0,1,0) with drift
Q* = 3.9064, df = 5, p-value = 0.563

Model df: 0.   Total lags used: 5</code></pre>
</div>
</div>
<p>The test P-value is even higher in this case, suggesting the remaining residuals appear to behave even more like white noise than in the previous specification.</p>
<p>Now to look at projections from the model into the 1990s:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>best_arima_lambda <span class="sc">|&gt;</span> <span class="fu">forecast</span>(<span class="at">h=</span><span class="dv">35</span>) <span class="sc">|&gt;</span> <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Using this specification we get a qualitatively different long-term projection with, on the identity scale of the data itself, a much narrower long-term projection interval.</p>
</section>
<section id="comparing-model-specifications" class="level3">
<h3 class="anchored" data-anchor-id="comparing-model-specifications">Comparing model specifications</h3>
<p>So, the two different ARIMA specifications arrived at - one with additional pre-transformation of the data before differencing; the other without - lead to qualitatively different long-term projections. Do we have any reason to presume one specification is better than the other?</p>
<p>I guess we could look at the AIC and BIC of the two models:</p>
<div class="cell" data-warn="true">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(best_arima_nolambda, best_arima_lambda)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                    df      AIC
best_arima_nolambda  2 374.6684
best_arima_lambda    2 189.4459</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(best_arima_nolambda, best_arima_lambda)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                    df      BIC
best_arima_nolambda  2 376.8505
best_arima_lambda    2 191.7169</code></pre>
</div>
</div>
<p>Here the lower scores for the model with a Box-Cox transformation suggest it should be preferred. However, as both functions warn, the number of observations differ between the two specifications. This is likely because the no-lambda version differences the data twice, whereas the with-lambda specification differences the data once, and so the no-lambda version should have one fewer observation. Let’s check this:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>n_obs_nolambda <span class="ot">&lt;-</span> <span class="fu">summary</span>(best_arima_nolambda)<span class="sc">$</span>nobs</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>n_obs_lambda <span class="ot">&lt;-</span> <span class="fu">summary</span>(best_arima_lambda)<span class="sc">$</span>nobs</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Observations for no lambda:"</span>, n_obs_nolambda))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Observations for no lambda: 22"</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Observations for with-lambda:"</span>, n_obs_lambda))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Observations for with-lambda: 23"</code></pre>
</div>
</div>
<p>Yes. This seems to be the cause of the difference.</p>
<p>Another way of comparing the models is by using the <code>accuracy()</code> function, which reports a range of accuracy measures:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"No lambda specification: "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "No lambda specification: "</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy</span>(best_arima_nolambda)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                   ME    RMSE      MAE      MPE     MAPE      MASE       ACF1
Training set 268.7263 1039.34 758.5374 4.777142 10.02628 0.5746874 -0.2848601</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"With-lambda specification: "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "With-lambda specification: "</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy</span>(best_arima_lambda)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                   ME     RMSE      MAE       MPE     MAPE      MASE      ACF1
Training set 123.1317 934.6956 724.6794 -5.484572 12.91378 0.5490357 -0.169863</code></pre>
</div>
</div>
<p>What’s returned by <code>accuracy()</code> comprises one row (labelled <code>Training set</code>) and seven columns, each for <a href="https://otexts.com/fpp2/accuracy.html">a different accuracy metric</a>. A common (and relatively easy-to-understand) accuracy measure is <code>RMSE</code>, which stands for (square) root mean squared error. According to this measure, the Box-Cox transformed ARIMA model outperforms the untransformed (by double-differenced) ARIMA model, so perhaps it should be preferred.</p>
<p>However, as the act of transforming the data in effect changes (by design) the units of the data, perhaps <code>RMSE</code> is not appropriate to use for comparison. Instead, there is a measure called <code>MAPE</code>, which stands for “mean absolute percentage error”, that might be more appropriate to use because of the differences in scales. According to this measure, the Box-Cox transformed specification has a <em>higher</em> error score than the no-lambda specification (around 13% instead of around 10%), suggesting instead the no-lambda specification should be preferred instead.</p>
<p>So what to do? Once again, the ‘solution’ is probably just to employ some degree of informed subjective judgement, along with a lot of <em>epistemic humility</em>. The measures above can help inform our modelling decisions, but they cannot make these decisions for us.</p>
</section>
<section id="discussion-and-coming-up" class="level3">
<h3 class="anchored" data-anchor-id="discussion-and-coming-up">Discussion and coming up</h3>
<p>For the first three posts in this time-series miniseries, we looked mainly at the theory of the three components of the ARIMA time series modelling approach. This is the first approach where we’ve used ARIMA in practice. Hopefully you got a sense of two different things:</p>
<ul>
<li>That because of packages like <code>forecast</code>, getting R to produce and forecast from an ARIMA model is relatively quick and straightforward to do in practice.</li>
<li>That even in this brief applied example of applied time series, we started to learn about a range of concepts - such as the auto-correlation function (ACF), the Box-Cox transformation, and alternative measures of accuracy - which were not mentioned in the previous three posts on ARIMA.</li>
</ul>
<p>Indeed, if you review <a href="https://otexts.com/fpp2/">the main book associated with the forecasting package</a>, you can see that ARIMA comprises just a small part of the overall time series toolkit. There’s a lot more that can be covered, including some methods that are simpler to ARIMA, some methods (in particular SARIMA) which are further extensions of ARIMA, some methods that are alternatives to ARIMA, and some methods that are decidedly more complicated than ARIMA. By focusing on the theory of ARIMA in the last three posts, I’ve aimed to cover something in the middle-ground of the overall toolbox.</p>
</section>
</section>
<section id="seasonal-time-series" class="level2">
<h2 class="anchored" data-anchor-id="seasonal-time-series">Seasonal Time Series</h2>
<p>In previous posts on time series, we decomposed then applied a common general purpose modelling strategy for working with time series data called ARIMA. ARIMA model can involve autoregressive components (<code>AR(p)</code>), integration/differencing components <code>I(d)</code>, and moving average components (<code>MA(q)</code>). As we saw, the time series data can also be pre-transformed, in ways other than just differencing; the example of this we saw was the application of the Box-Cox transformation for regularising the variance of the outcome, and includes logging of values as one possible transformation within the framework.</p>
<p>The data we used previous was annual data, showing the numbers of airmiles travelled in the USA by year up to the 1960s. Of course, however, many types of time series data are sub-annual, reported not just by year, but by quarter, or month, or day as well. Data disaggregated into sub-annual units often exhibit <strong>seasonal variation</strong>, patterns that repeat themselves at regular intervals within a 12 month cycle. <a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<p>In this post we will look at some seasonal data, and consider two strategies for working with this data: STL decomposition; and Seasonal ARIMA (SARIMA).</p>
<section id="an-example-dataset" class="level3">
<h3 class="anchored" data-anchor-id="an-example-dataset">An example dataset</h3>
<p>Let’s continue to use the examples and convenience functions from the <code>forecast</code> package used in the previous post, and for which the excellent book <a href="https://otexts.com/fpp3/"><strong>Forecasting: Principles and Practice</strong></a> is available freely online.</p>
<p>First some packages</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fpp3)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now some seasonal data</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using this example dataset: https://otexts.com/fpp3/components.html</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(us_employment)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>us_retail_employment <span class="ot">&lt;-</span> us_employment <span class="sc">|&gt;</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Title <span class="sc">==</span> <span class="st">"Retail Trade"</span>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>us_retail_employment</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 969 x 4 [1M]
# Key:       Series_ID [1]
      Month Series_ID     Title        Employed
      &lt;mth&gt; &lt;chr&gt;         &lt;chr&gt;           &lt;dbl&gt;
 1 1939 Jan CEU4200000001 Retail Trade    3009 
 2 1939 Feb CEU4200000001 Retail Trade    3002.
 3 1939 Mar CEU4200000001 Retail Trade    3052.
 4 1939 Apr CEU4200000001 Retail Trade    3098.
 5 1939 May CEU4200000001 Retail Trade    3123 
 6 1939 Jun CEU4200000001 Retail Trade    3141.
 7 1939 Jul CEU4200000001 Retail Trade    3100 
 8 1939 Aug CEU4200000001 Retail Trade    3092.
 9 1939 Sep CEU4200000001 Retail Trade    3191.
10 1939 Oct CEU4200000001 Retail Trade    3242.
# ℹ 959 more rows</code></pre>
</div>
</div>
<p>There are two differences we can see with this dataset compared with previous time series data we’ve looked at.</p>
<p>Firstly, the data looks like a <code>data.frame</code> object, or more specifically a <code>tibble()</code> (due to the additional metadata at the top). In fact they are of a special type of <code>tibble</code> called a <code>tsibble</code>, which is basically a modified version of a tibble optimised to work with time series data. We can check this by interrogating the class attributes of <code>us_employment</code>:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(us_retail_employment)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "tbl_ts"     "tbl_df"     "tbl"        "data.frame"</code></pre>
</div>
</div>
<p>These class attributes go broadly from the most specific type of object class: <code>tbl_ts</code> (the tsibble); to the most general type of object class: the <code>data.frame</code>.</p>
<p>Secondly, we can see that the data are disaggregated not by year as in the last post’s example, but also by month. So, what does this monthly data actually look like?</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(us_retail_employment, Employed) <span class="sc">+</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Persons (thousands)"</span>,</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Total employment in US retail"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This data looks… spikey. There’s clearly both a long-term trend - including periods of faster and slower growth, and occasionally some falls - but there’s also what looks like a series of near-vertical spikes along this trend, at what may be regular intervals. What happens if we zoom into a smaller part of the time series?</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    us_retail_employment <span class="sc">|&gt;</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="fu">year</span>(Month) <span class="sc">&gt;=</span><span class="dv">1990</span>), </span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    Employed) <span class="sc">+</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Persons (thousands)"</span>,</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Total employment in US retail"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here we can start to see there’s not just a single repeating ‘vertical spike’, but a pattern that appears to repeat within each year, for each year. Let’s zoom in even further, for just three years:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    us_retail_employment <span class="sc">|&gt;</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="fu">between</span>(<span class="fu">year</span>(Month), <span class="dv">1994</span>, <span class="dv">1996</span>)), </span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    Employed) <span class="sc">+</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Persons (thousands)"</span>,</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Total employment in US retail"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Although each of these three years is different in terms of the average number of persons employed in retail, they are similar in terms of having a spike in employment towards the end of the year, then a drop off at the start of the year, then a relative plateau for the middle of the year.</p>
<p>This is an example of a seasonal pattern, information that gets revealed about a time series when we use a sub-annual resolution that might not be apparent it we used only annual data. How do we handle this kind of data?</p>
</section>
<section id="approach-one-reannualise" class="level3">
<h3 class="anchored" data-anchor-id="approach-one-reannualise">Approach one: reannualise</h3>
<p>Of course we could simply reaggregate the data to an annual series:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>us_retail_employment <span class="sc">|&gt;</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">year</span>(Month)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">index_by</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">Employed =</span> <span class="fu">sum</span>(Employed)</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">autoplot</span>(., Employed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>One thing we can notice with this is that there appears to be a big drop in total employment for the last year. This is likely because the last year is incomplete, so whereas previous years are summing up 12 months’ observations, for the last year a smaller number of months are being summed up. We could then drop the last year:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>us_retail_employment <span class="sc">|&gt;</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">year</span>(Month)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">index_by</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">Employed =</span> <span class="fu">sum</span>(Employed)</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="fu">max</span>(year)) <span class="sc">%&gt;%</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">autoplot</span>(., Employed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>But then we are losing some data that we really have. Even if we don’t have the full year, we might be able to get a sense from just the first few months worth of data whether the overall values for the last year are likely to be up or down compared to the same month in the previous years. We could even turn this single annual time series into 12 separate series: comparing Januaries with Januaries, Februaries with Februaries, and so on.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>us_retail_employment <span class="sc">|&gt;</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">year</span>(Month), </span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">month =</span> <span class="fu">month</span>(Month, <span class="at">label =</span> <span class="cn">TRUE</span> )</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(year, Employed)</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>month) <span class="sc">+</span> </span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here we can see that comparing annual month-by-month shows a very similar trend overall. It’s as if each month’s values could be thought of as part of an annual ‘signal’ (an underlying long-term trend) <strong>plus</strong> a seasonal adjustment up or down: compared with the annual trend, Novembers and Decembers are likely to be high, and Januaries and Februaries to be low; and so on.</p>
<p>It’s this intuition - That we have a trend component, and a seasonal component - which leads us to our second strategy: decomposition.</p>
</section>
<section id="approach-two-seasonal-composition" class="level3">
<h3 class="anchored" data-anchor-id="approach-two-seasonal-composition">Approach Two: Seasonal Composition</h3>
<p>The basic intuition of decomposition is to break sub-annual data into a series of parts: The underling long term <strong>trend</strong> component; and repeating (usually) annual <strong>seasonal</strong> component.</p>
<p>A common method for performing this kind of decomposition is known as <a href="https://otexts.com/fpp3/stl.html"><strong>STL</strong></a>. This actually stands for <em>Seasonal and Trend Decomposition using Loess</em> (Where Loess is itself another acronym). However it’s <em>heuristically</em> easier to imagine it stands for <strong>Season-Trend-Leftover</strong>, as it tends to generate three outputs from a single time-series input that correspond to these three components. Let’s regenerate <a href="https://otexts.com/fpp3/stl.html">the example in the forecasting book</a> and then consider the outputs further:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>us_retail_employment <span class="sc">|&gt;</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">year</span>(Month) <span class="sc">&gt;=</span> <span class="dv">1990</span>) <span class="sc">|&gt;</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">STL</span>(Employed <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">season</span>(<span class="at">window =</span> <span class="st">"periodic"</span>),</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">|&gt;</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The plotted output contain four rows. These are, respectively:</p>
<ul>
<li><strong>Top Row</strong>: The input data from the dataset</li>
<li><strong>Second Row</strong>: The <em>trend</em> component from STL decomposition</li>
<li><strong>Third Row</strong>: The <em>seasonal</em> component from the STL decomposition</li>
<li><strong>Bottom Row</strong>: The remainder (or <em>leftover</em>) component from the STL decomposition.</li>
</ul>
<p>So, what’s going on?</p>
<p>STL uses an algorithm to find a repeated sequence (the <em>seasonal</em> component) in the data that, once subtracted from a long term <em>trend</em>, leaves a remainder (set of errors or deviations from observations) that is minimised in some way, and ideally random like white noise.</p>
<p>If you expanded the code chunk above, you will see two parameters as part of the STL model: the <code>window</code> argument for a <code>trend()</code> function; and the <code>window</code> argument for a <code>season()</code> function. This implies there are ways of setting up STL differently, and these would produce different output components. What happens if we change the <code>window</code> argument to <code>1</code> (which I think is its smallest allowable value)?</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>us_retail_employment <span class="sc">|&gt;</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">year</span>(Month) <span class="sc">&gt;=</span> <span class="dv">1990</span>) <span class="sc">|&gt;</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">year</span>(Month) <span class="sc">&lt;=</span> <span class="dv">2017</span>) <span class="sc">|&gt;</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">STL</span>(Employed <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">season</span>(<span class="at">window =</span> <span class="st">"periodic"</span>),</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">|&gt;</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here the trend component becomes, for want of a better term, ‘wigglier’. And the remainder term, except for a strange data artefact at the end, appears much smaller. So what does the <code>window</code> argument do?</p>
<p>Conceptually, what the <code>window</code> argument to <code>trend()</code> does is adjust the <strong>stiffness</strong> of the curve that the trendline uses to fit to the data. A longer window, indicated by a higher argument value, makes the curve stiffer, and a shorter window, indicated by a lower argument value, makes the curve less stiff. We’ve adjusted from the default window length of <code>7</code> to a much shorter length of <code>1</code>, making it much less stiff.<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> Let’s look at the effect of increasing the window length instead:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>us_retail_employment <span class="sc">|&gt;</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">year</span>(Month) <span class="sc">&gt;=</span> <span class="dv">1990</span>) <span class="sc">|&gt;</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">STL</span>(Employed <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="dv">31</span>) <span class="sc">+</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">season</span>(<span class="at">window =</span> <span class="st">"periodic"</span>),</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">|&gt;</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here we can see that, as well as the trend term being somewhat smoother than when a size <code>7</code> window length was used, the remainder term, though looking quite noisy, doesn’t really look random anymore. In particular, there seems to be a fairly big jump in the remainder component in the late 2000s. The remainder series also does not particularly stationary, lurching up and down at particular points in the series.</p>
<p>In effect, the higher stiffness of the trend component means it is not able to capture and represent enough signal in the data, and so some of that ‘signal’ is still present in the remainder term, when it should be extracted instead.</p>
<p>Now what happens if we adjust the window argument in the <code>season()</code> function instead?</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>us_retail_employment <span class="sc">|&gt;</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">year</span>(Month) <span class="sc">&gt;=</span> <span class="dv">1990</span>) <span class="sc">|&gt;</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">STL</span>(Employed <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">season</span>(<span class="at">window =</span> <span class="dv">5</span>),</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">|&gt;</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In the above I’ve reduced the season window size (by default it’s infinite). Whereas before this seasonal pattern was forced to be constant for the whole time period, this time we an see that it changes, or ‘evolves’, over the course of the time series. We can also see that the remainder component, though looking quite random, now looks especially ‘spiky’, suggesting that the kinds of residuals left are somewhat further from Guassian white noise than in the first example.</p>
<section id="section-concluding-thoughts" class="level4">
<h4 class="anchored" data-anchor-id="section-concluding-thoughts">Section concluding thoughts</h4>
<p>STL decomposition is one of a number of strategies for decomposition available to us. Other examples are described here. However the aims and principles of decomposition are somewhat similar no matter what approach is used.</p>
<p>Having performed a decomposition on time series data, we <em>could</em> potentially apply something like an ARIMA model to the <strong>trend</strong> component of the data alone for purposes of projection. If using a constant seasonal component, we could then add this component onto forecast values from the trend component, along with noise consistent with the properties of the remainder component. However, there is a variant of the ARIMA model specification that can work with this kind of seasonal data directly. Let’s look at that now</p>
</section>
</section>
<section id="approach-three-sarima" class="level3">
<h3 class="anchored" data-anchor-id="approach-three-sarima">Approach Three: SARIMA</h3>
<p>SARIMA stands for <a href="https://otexts.com/fpp2/seasonal-arima.html">‘Seasonal ARIMA’</a> (where of course ARIMA stands for Autoregressive-Integrated-Moving Average). Whereas an ARIMA model has a specification shorthand <code>ARIMA(p, d, q)</code>, a SARIMA model has an extended specification: <code>SARIMA(p, d, q) (P, D, Q)_S</code>. This means that whereas <code>ARIMA</code> has three parameters to specify, a SARIMA model has seven. This might appear like a big jump in model complexity, but the gap from ARIMA to SARIMA is smaller than it first appears.</p>
<p>To see this it’s first noticing that, as well as terms <code>p</code>, <code>d</code> and <code>q</code>, there are also terms <code>P</code>, <code>D</code> and <code>Q</code>. This would suggest that whatever Autoregressive (<code>p</code>), integration (<code>d</code>) and moving average (<code>q</code>) processes are involved in standard ARIMA are also involved in another capacity in SARIMA. And what’s this other capacity? The clue to this is in the <code>S</code> term.</p>
<p><code>S</code> <a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> stands for the <strong>seasonal</strong> component of the model, and specifies the number of observations that are expected to include a repeating seasonal cycle. As most seasonal cycles are annual, this means <code>S</code> will be <code>12</code> if the data are monthly, <code>4</code> if the data are quarterly, and so on.</p>
<p>The UPPERCASE <code>P</code>, <code>D</code> and <code>Q</code> terms then specify which standard ARIMA processes should be modelled as occurring every <code>S</code> steps in the data series. Although algebraically this means SARIMA models may look a lot more complicated than standard ARIMA models, it’s really the same process, and the same intuition, applied twice: to characterising the seasonal ‘signals’ in the time series, and to characteristing the non-seasonal ‘signals’ in the time series.</p>
<p>Although there are important diagnostic charts and heuristics to use when determining and judging which SARIMA specification may be most appropriate for modelling seasonal data, such as the PACF and ACF, we can still use the <code>auto.arima()</code> function to see if the best SARIMA specification can be identified algorithmically:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>best_sarima_model <span class="ot">&lt;-</span> <span class="fu">auto.arima</span>(<span class="fu">as.ts</span>(us_retail_employment, <span class="st">"Employed"</span>))</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>best_sarima_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Series: as.ts(us_retail_employment, "Employed") 
ARIMA(1,1,2)(2,1,2)[12] 

Coefficients:
         ar1      ma1     ma2     sar1     sar2    sma1     sma2
      0.8784  -0.8428  0.1028  -0.6962  -0.0673  0.2117  -0.3873
s.e.  0.0374   0.0481  0.0332   0.0977   0.0691  0.0937   0.0776

sigma^2 = 1442:  log likelihood = -4832.08
AIC=9680.16   AICc=9680.31   BIC=9719.06</code></pre>
</div>
</div>
<p>Here <code>auto.arima()</code> produced an <code>ARIMA(1, 1, 2) (2, 1, 2)_12</code> specification, meaning <code>p=1</code>, <code>d=1</code>, <code>q=2</code> for the non-seasonal part; and <code>P=2</code>, <code>D=1</code>, <code>Q=2</code> for the seasonal part.</p>
<p>What kind of forecasts does this produce?</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>best_sarima_model <span class="sc">|&gt;</span> </span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">forecast</span>(<span class="at">h=</span><span class="dv">48</span>) <span class="sc">|&gt;</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see the forecasts tend to repeat the seasonal pattern apparent throughout the observed data, and also widen in the usual way the further we move from the observed data.</p>
</section>
<section id="summing-up-2" class="level3">
<h3 class="anchored" data-anchor-id="summing-up-2">Summing up</h3>
<p>In this post we have looked at three approaches for working with seasonal data: aggregating seasonality away; decomposition; and SARIMA. These are far from an exhaustive list, but hopefully illustrate some common strategies for working with this kind of data.</p>
</section>
</section>
<section id="vector-autoregression-var" class="level2">
<h2 class="anchored" data-anchor-id="vector-autoregression-var">Vector Autoregression (VAR)</h2>
<p>In this post, we’ll take time series in a different direction, to show an application of <strong>multivariate regression</strong> common in time series, called <strong>vector autoregression</strong> (VAR). VAR is both simpler in some ways, and more complex in other ways, than SARIMA modelling. It’s simpler in that, as the name suggests, moving average (<code>MA</code>) terms tend to not be part of VAR models; we’ll also not be considering seasonality either. But it’s more complicated in the sense that we are jointly modelling two outcomes at the same time.</p>
<section id="model-family-tree" class="level3">
<h3 class="anchored" data-anchor-id="model-family-tree">Model family tree</h3>
<p>The following figure aims to show the family resemblances between model specifications and challenges:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart TB 
    uvm(univariate models)
    mvm(multivariate models)

    ar("AR(p)")
    i("I(d)")
    ma("MA(q)")
    arima("ARIMA(p, d, q)")
    sarima("ARIMA(p, d, q)[P, D, Q]_s")
    var(VAR)

    ar --&gt; var
    mvm --&gt; var

    i -.-&gt; var

    uvm -- autoregression --&gt; ar
    uvm -- differencing --&gt; i
    uvm -- moving average --&gt; ma
    ar &amp; i &amp; ma --&gt; arima

    arima -- seasonality --&gt;  sarima

</pre>
</div>
</div>
</div>
</div>
<p>So, the VAR model is an extension of the autoregressive component of a standard, univariate <code>AR(p)</code> specification models to multivariate models. It can also include both predictor and response variables that are differenced, hence the the dashed line from <code>I(d)</code> to VAR.</p>
</section>
<section id="so-what-is-a-multivariate-model" class="level3">
<h3 class="anchored" data-anchor-id="so-what-is-a-multivariate-model">So what is a multivariate model?</h3>
<p>You might have seen the term <em>multivariate model</em> before, and think you’re familiar with what it means.</p>
<p>In particular, you might have been taught that whereas a univariate regression model looks something like this:</p>
<p><span class="math display">\[
y = \beta_0 + \beta_1 x_1 + \epsilon
\]</span></p>
<p>A multivariate regression model looks more like this:</p>
<p><span class="math display">\[
y = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \epsilon
\]</span></p>
<p>i.e.&nbsp;You might have been taught that, if the predictors include one term for the <em>intercept</em> (the <span class="math inline">\(\beta_0\)</span> term) and one term for the <em>slope</em> (the <span class="math inline">\(\beta_1\)</span> term), then this is a <em>univariate model</em>. But if there are two or more terms that can claim to be ‘the slope’ then this is a <em>multivariate model</em>.</p>
<p>However, this isn’t the real distinction between a univariate model and a multivariate model. To see this distinction we have to return, for the umpeenth time, to the ‘grandmother model’ specification first introduced at <a href="../../../pages/main-course/intro-to-glms/index.html">the start of the main course</a>:</p>
<p><strong>Stochastic Component</strong></p>
<p><span class="math display">\[
Y \sim f(\theta, \alpha)
\]</span></p>
<p><strong>Systematic Component</strong></p>
<p><span class="math display">\[
\theta = g(X, \beta)
\]</span></p>
<p>Now, both the response data, <span class="math inline">\(Y\)</span>, and the predictor data, <span class="math inline">\(X\)</span>, are both taken from the same rectangular dataset, <span class="math inline">\(D\)</span>. Let’s say this dataset, <span class="math inline">\(D\)</span>, has six rows and five columns. As a matrix it would look something like this:</p>
<p><span class="math display">\[
D =
\begin{pmatrix}
d_{1,1} &amp; d_{1,2} &amp; d_{1,3} &amp; d_{1, 4} &amp; d_{1,5} \\
d_{2,1} &amp; d_{2,2} &amp; d_{2,3} &amp; d_{2, 4} &amp; d_{2,5} \\
d_{3,1} &amp; d_{3,2} &amp; d_{3,3} &amp; d_{3, 4} &amp; d_{3,5} \\
d_{4,1} &amp; d_{4,2} &amp; d_{4,3} &amp; d_{4, 4} &amp; d_{4,5} \\
d_{5,1} &amp; d_{5,2} &amp; d_{5,3} &amp; d_{5, 4} &amp; d_{5,5} \\
d_{6,1} &amp; d_{6,2} &amp; d_{6,3} &amp; d_{6, 4} &amp; d_{6,5}
\end{pmatrix}
\]</span></p>
<p>Here the dataset <span class="math inline">\(D\)</span> is made up of a whole series of elements <span class="math inline">\(d_{i,j}\)</span>, where the first subset value indicates the row number <span class="math inline">\(i\)</span> and the second subset value indicates the column number <span class="math inline">\(j\)</span>. So, for example, <span class="math inline">\(d_{5, 2}\)</span> indicates the value of the 5th row and 2nd column, whereas <span class="math inline">\(d_{2, 5}\)</span> indicates the value of the 2nd row and 5th column.</p>
<p>Fundamentally, the first challenge in building a model is deciding which <em>columns</em> from <span class="math inline">\(D\)</span> we put in the predictor matrix <span class="math inline">\(X\)</span>, and which parts we put into the response matrix <span class="math inline">\(Y\)</span>. For example, if we wanted to predict the third column <span class="math inline">\(j=3\)</span> given the fifth column <span class="math inline">\(j=5\)</span> our predictor and response matrices would look as follows:</p>
<div class="columns">
<div class="column" style="width:25%;">
<p><span class="math display">\[
Y = \begin{pmatrix}
d_{1,3} \\
d_{2,3} \\
d_{3,3} \\
d_{4,3} \\
d_{5,3} \\
d_{6,3}  
\end{pmatrix}
\]</span></p>
</div><div class="column" style="width:25%;">
<p><span class="math display">\[
X = \begin{pmatrix}
1 &amp; d_{1,5} \\
1 &amp; d_{2,5} \\
1 &amp; d_{3,5} \\
1 &amp; d_{4,5} \\
1 &amp; d_{5,5} \\
1 &amp; d_{6,5}  
\end{pmatrix}
\]</span></p>
</div>
</div>
<p>Where does the column of 1s come from? This is how we specify, in matrix notation, that we want an intercept term to be calculated. Models don’t <em>have</em> to have intercept terms, but in almost all cases we’re likely to be familiar with, they tend to.</p>
<p>Let’s say we now want to include two columns, 2 and 5, from <span class="math inline">\(D\)</span> in the predictor matrix, leading to what’s commonly (and wrongly) called a ‘multivariate regression’. This means that <span class="math inline">\(Y\)</span> stays the same, but X is now as follows:</p>
<p><span class="math display">\[
X = \begin{pmatrix}
1 &amp; d_{1,2}  &amp; d_{1,5}\\
1 &amp; d_{2,2}  &amp; d_{2,5}\\
1 &amp; d_{3,2}  &amp; d_{3,5}\\
1 &amp; d_{4,2}  &amp; d_{4,5}\\
1 &amp; d_{5,2}  &amp; d_{5,5}\\
1 &amp; d_{6,2}  &amp; d_{6,5}
\end{pmatrix}
\]</span></p>
<p>No matter now many columns we include in the predictor matrix, X, however, we still don’t have a real <strong>multivariate regression</strong> model specification. Even if X had a hundred columns, or a thousand, it would still not be a <strong>multivariate regression</strong> in the more technical sense of the term.</p>
<p>Instead, <em>here’s</em> an example of a <strong>multivariate regression</strong> model:</p>
<div class="columns">
<div class="column" style="width:25%;">
<p><span class="math display">\[
Y = \begin{pmatrix}
d_{1,1} &amp; d_{1,3} \\
d_{2,1} &amp; d_{2,3} \\
d_{3,1} &amp; d_{3,3} \\
d_{4,1} &amp; d_{4,3} \\
d_{5,1} &amp; d_{5,3} \\
d_{6,1} &amp; d_{6,3}  
\end{pmatrix}
\]</span></p>
</div><div class="column" style="width:25%;">
<p><span class="math display">\[
X = \begin{pmatrix}
1 &amp; d_{1,5} \\
1 &amp; d_{2,5} \\
1 &amp; d_{3,5} \\
1 &amp; d_{4,5} \\
1 &amp; d_{5,5} \\
1 &amp; d_{6,5}  
\end{pmatrix}
\]</span></p>
</div>
</div>
<p>This is an example of a <strong>multivariate regression model</strong>. We encountered it before when we used the multivariate normal distribution <a href="../../../pages/main-course/likelihood-and-simulation-theory/index.html">here</a>, and when we draw from the posterior distribution of Bayesian models <a href="../../../pages/main-course/complete-simulation-example/index.html">here</a>, but this is the first time we’ve considered multivariate modelling in the context of trying to represent something we suspect to be true about the world, rather than our uncertainty about the world. And it’s the first example of multivariate regression we’ve encountered in this series. For every previous model, no matter how apparently disparate, complicated or exotic they may appear, they’ve been <em>univariate</em> regression models in the sense that the response component <span class="math inline">\(Y\)</span> has always only contained one column only.</p>
<p>So, with this definition of multivariate regression, let’s now look at VAR as a particular application of multivariate regression used in time series.</p>
</section>
<section id="vector-autoregression" class="level3">
<h3 class="anchored" data-anchor-id="vector-autoregression">Vector Autoregression</h3>
<p>Let’s start with a semi-technical definition:</p>
<blockquote class="blockquote">
<p>In vector autoregression (VAR) the values of two or more outcomes, <span class="math inline">\(\{Y_1(T), Y_2(T)\}\)</span>, are predicted based on previous values of those same outcomes <span class="math inline">\(\{Y_1(T-k), Y_2(T-k)\}\)</span>, for various lag periods <span class="math inline">\(k\)</span>.</p>
</blockquote>
<p>Where <span class="math inline">\(Y\)</span> has two columns, and an <code>AR(1)</code> specification (i.e.&nbsp;<code>k</code> is just 1), how is this different from simply running two separate <code>AR(1)</code> regression models, one for <span class="math inline">\(Y_1\)</span>, and the other for <span class="math inline">\(Y_2\)</span>?</p>
<p>Well, graphically, two separate <code>AR(1)</code> models proposes the following paths of influence:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
Y1_T["Y1(T)"]
Y2_T["Y2(T)"]

Y1_T1["Y1(T-1)"]
Y2_T1["Y2(T-1)"]

Y1_T1 --&gt; Y1_T
Y2_T1 --&gt; Y2_T
</pre>
</div>
</div>
</div>
</div>
<p>By contrast, the paths implied and allowed in the corresponding <code>VAR(1)</code> model look more like the following:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
Y1_T["Y1(T)"]
Y2_T["Y2(T)"]

Y1_T1["Y1(T-1)"]
Y2_T1["Y2(T-1)"]

Y1_T1 &amp; Y2_T1 --&gt; Y1_T &amp; Y2_T
</pre>
</div>
</div>
</div>
</div>
<p>So, each of the two outcomes at time T <em>is influenced both by its own previous value, but also by the previous value of the other outcome</em>. This <em>other outcome</em> influence is what is represented in the figure above by the diagonal lines: from <code>Y2(T-1)</code> to <code>Y1(T)</code>, and from <code>Y1(T-1)</code> to <code>Y2(T)</code>.</p>
<p>Expressed verbally, if we imagine two entities - <strong>self</strong> and <strong>other</strong> - tracked through time, <strong>self</strong> is influenced both by <em>self’s history</em>, but also by <em>other’s history</em> too.</p>
</section>
<section id="example-and-application-in-r" class="level3">
<h3 class="anchored" data-anchor-id="example-and-application-in-r">Example and application in R</h3>
<p>In <a href="https://jonminton.github.io/jon-blog/posts/still-the-economy/index.html">a blog post</a>, I discussed how I suspect economic growth and longevity growth trends are correlated. What I proposed doesn’t exactly lend itself to the simplest kind of <code>VAR(1)</code> model specification, because I suggested a longer lag between the influence of economic growth on longevity growth, and a change in the fundamentals of growth in both cases. However, as an example of VAR I will ignore these complexities, and use the data I prepared for that post: I also discussed how I suspect economic growth and longevity growth trends are correlated. What I proposed doesn’t exactly lend itself to the simplest kind of <code>VAR(1)</code> model specification, because I suggested a longer lag between the influence of economic growth on longevity growth, and a change in the fundamentals of growth in both cases. However, as an example of VAR I will ignore these complexities, and use the data I prepared for that post:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>gdp_growth_pct_series <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"still-the-economy-both-series.csv"</span>) </span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>gdp_growth_pct_series</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 147 × 5
    ...1  year series            pct_change period
   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;                  &lt;dbl&gt; &lt;chr&gt; 
 1     1  1949 1. Per Capita GDP     NA     Old   
 2     2  1950 1. Per Capita GDP      2.20  Old   
 3     3  1951 1. Per Capita GDP      2.92  Old   
 4     4  1952 1. Per Capita GDP      1.36  Old   
 5     5  1953 1. Per Capita GDP      5.07  Old   
 6     6  1954 1. Per Capita GDP      3.87  Old   
 7     7  1955 1. Per Capita GDP      3.55  Old   
 8     8  1956 1. Per Capita GDP      1.28  Old   
 9     9  1957 1. Per Capita GDP      1.49  Old   
10    10  1958 1. Per Capita GDP      0.815 Old   
# ℹ 137 more rows</code></pre>
</div>
</div>
<p>We need to do a certain amount of reformatting to bring this into a useful format:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>wide_ts_series <span class="ot">&lt;-</span> </span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>gdp_growth_pct_series <span class="sc">|&gt;</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">`</span><span class="at">...1</span><span class="st">`</span>, period)) <span class="sc">|&gt;</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">short_series =</span> <span class="fu">case_when</span>(</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>            series <span class="sc">==</span> <span class="st">"1. Per Capita GDP"</span> <span class="sc">~</span> <span class="st">'gdp'</span>,</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>            series <span class="sc">==</span> <span class="st">"2. Life Expectancy at Birth"</span> <span class="sc">~</span> <span class="st">'e0'</span>,</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>            <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>series) <span class="sc">|&gt;</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> short_series, <span class="at">values_from =</span> pct_change) <span class="sc">|&gt;</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">lag_gdp =</span> <span class="fu">lag</span>(gdp),</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">lag_e0 =</span> <span class="fu">lag</span>(e0)</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">complete.cases</span>(.))</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>wide_ts_series</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 71 × 5
    year   gdp      e0 lag_gdp  lag_e0
   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
 1  1951 2.92  -0.568    2.20   0.763 
 2  1952 1.36   1.89     2.92  -0.568 
 3  1953 5.07   0.388    1.36   1.89  
 4  1954 3.87   0.530    5.07   0.388 
 5  1955 3.55  -0.0570   3.87   0.530 
 6  1956 1.28   0.385    3.55  -0.0570
 7  1957 1.49   0.170    1.28   0.385 
 8  1958 0.815  0.255    1.49   0.170 
 9  1959 3.70   0.184    0.815  0.255 
10  1960 5.72   0.268    3.70   0.184 
# ℹ 61 more rows</code></pre>
</div>
</div>
<p>So, we can map columns to parts of the VAR specification as follows:</p>
<ul>
<li><code>Y1</code>: gdp</li>
<li><code>Y2</code>: e0 (life expectancy at birth)</li>
<li><code>period T</code>: <code>gdp</code> and <code>e0</code></li>
<li><code>period T-1</code>: <code>lag_gdp</code> and <code>lag_e0</code></li>
</ul>
<p>To include two or more variables as the response part, <span class="math inline">\(Y\)</span>, of a linear model we can use the <code>cbind()</code> function to combine more than one variable to the left hand side of the linear regression formula for <code>lm</code> or <code>glm</code>:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>var_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(gdp, e0) <span class="sc">~</span> lag_gdp <span class="sc">+</span> lag_e0,</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> wide_ts_series</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>var_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = cbind(gdp, e0) ~ lag_gdp + lag_e0, data = wide_ts_series)

Coefficients:
             gdp       e0      
(Intercept)   1.99440   0.28108
lag_gdp       0.06173   0.01179
lag_e0       -0.48525  -0.33063</code></pre>
</div>
</div>
<p>We can see here that the model reports a small matrix of coefficients: three rows (one for each coefficient term) and two columns: one for each of the response variables. This is as we should expect.</p>
<p>Back in <a href="../../../pages/main-course/complete-simulation-example/index.html">the main course</a>, we saw we could extract the coefficients, variance-covariance matrix, and error terms of a linear regression model using the functions <code>coefficients</code>, <code>vcov</code>, and <code>sigma</code> respectively.<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a> Let’s use those functions here too:</p>
<p>First the coefficients</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coefficients</span>(var_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                    gdp          e0
(Intercept)  1.99439587  0.28108028
lag_gdp      0.06172721  0.01178781
lag_e0      -0.48524808 -0.33062640</code></pre>
</div>
</div>
<p>And now the variance-covariance matrix:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vcov</span>(var_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                gdp:(Intercept)   gdp:lag_gdp    gdp:lag_e0 e0:(Intercept)
gdp:(Intercept)    0.1804533467 -0.0272190933 -0.1129646084   0.0039007790
gdp:lag_gdp       -0.0272190933  0.0164590434 -0.0180517467  -0.0005883829
gdp:lag_e0        -0.1129646084 -0.0180517467  0.6290771233  -0.0024419053
e0:(Intercept)     0.0039007790 -0.0005883829 -0.0024419053   0.0037904364
e0:lag_gdp        -0.0005883829  0.0003557878 -0.0003902165  -0.0005717391
e0:lag_e0         -0.0024419053 -0.0003902165  0.0135984779  -0.0023728303
                   e0:lag_gdp     e0:lag_e0
gdp:(Intercept) -0.0005883829 -0.0024419053
gdp:lag_gdp      0.0003557878 -0.0003902165
gdp:lag_e0      -0.0003902165  0.0135984779
e0:(Intercept)  -0.0005717391 -0.0023728303
e0:lag_gdp       0.0003457235 -0.0003791783
e0:lag_e0       -0.0003791783  0.0132138133</code></pre>
</div>
</div>
<p>And finally the error terms</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sigma</span>(var_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      gdp        e0 
2.6906051 0.3899529 </code></pre>
</div>
</div>
<p>The coefficients returns the same kind of 3x2 matrix we saw previously: two models run simultaneously. The error terms is now a vector of length 2: one for each of these models. The variance-covariance matrix is a square matrix of dimension 6: i.e.&nbsp;6 rows and 6 columns. This is the number of predictor coefficients in each model (the number of columns of <span class="math inline">\(X\)</span>, i.e.&nbsp;3) <em>times</em> the number of models simultaneously run, i.e.&nbsp;2.</p>
<p><span class="math inline">\(6^2\)</span> is <code>36</code>, which is the number of elements in the variance-covariance matrix of this VAR model. By contrast, if we had run two independent models - one for gdp and the other for e0 - we would have two 3x3 variance-variance matrices, producing a total of 18 <a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> terms. This should provide some reassurance that, when we run a multivariate regression model of two outcomes, we’re not <em>just</em> doing the equivalent of running separate regression models for each outcome, but in slightly fewer lines.</p>
<p>Now, let’s look at the model summary:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(var_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Response gdp :

Call:
lm(formula = gdp ~ lag_gdp + lag_e0, data = wide_ts_series)

Residuals:
    Min      1Q  Median      3Q     Max 
-12.679  -1.061   0.143   1.483   6.478 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  1.99440    0.42480   4.695 1.34e-05 ***
lag_gdp      0.06173    0.12829   0.481    0.632    
lag_e0      -0.48525    0.79314  -0.612    0.543    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.691 on 68 degrees of freedom
Multiple R-squared:  0.007555,  Adjusted R-squared:  -0.02163 
F-statistic: 0.2588 on 2 and 68 DF,  p-value: 0.7727


Response e0 :

Call:
lm(formula = e0 ~ lag_gdp + lag_e0, data = wide_ts_series)

Residuals:
     Min       1Q   Median       3Q      Max 
-1.45680 -0.19230 -0.00385  0.24379  1.38706 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.28108    0.06157   4.565 2.15e-05 ***
lag_gdp      0.01179    0.01859   0.634  0.52823    
lag_e0      -0.33063    0.11495  -2.876  0.00537 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.39 on 68 degrees of freedom
Multiple R-squared:  0.1086,    Adjusted R-squared:  0.08243 
F-statistic: 4.144 on 2 and 68 DF,  p-value: 0.02003</code></pre>
</div>
</div>
<p>The summary is now reported for each of the two outcomes: first <code>gdp</code>, then <code>e0</code>.</p>
<p>Remember that the outcome is percentage annual change in the outcome of interest from the previous year. i.e.&nbsp;both series have already been ‘differenced’ to produce approximately stationary series. It also means that the intercept terms are especially important, as they indicate the long-term trends observed in each series.</p>
<p>In this case the intercepts for both series are positive and statistically significant: over the long term, GDP has grown on average around 2% each year, and life expectancy by around 0.28%. As <a href="../../still-the-economy/index.qmd">the post this relates to</a> makes clear, however, these long-term trends may no longer apply.</p>
<p>Of the four lag (<code>AR(1)</code>) terms in the model(s), three are not statistically significant; not even close. The exception is the <code>lag_e0</code> term for the <code>e0</code> response model, which is statistically significant and negative. Its coefficient is also of similar magnitude to the intercept too.</p>
<p>What does this mean in practice? In effect, that annual mortality improvement trends have a tendency to <em>oscillate</em>: a better-than-average year tends to be followed by a worse-than-average year, and a worse-than-average year to be followed by a better-than-average year, in both cases at higher-than-chance rates.</p>
<p>What could be the cause of this oscillatory phenomenon? When it comes to longevity, the phenomenon is somewhat well understood (though perhaps not widely enough), and referred to as either ‘forward mortality displacement’ or, more chillingly, ‘harvesting’. This outcome likely comes about because, if there were an exceptionally bad year in terms of (say) influenza mortality, the most frail and vulnerable are likely to be those who die disproportionately from this additional mortality event. This means that the ‘stock’ of people remaining the following year have been selected, on average, to be slightly less frail and vulnerable than those who started the previous year. Similarly, an exceptionally ‘good’ year can mean that the average ‘stock’ of the population in the following year is slightly more frail than in an average year, so more susceptible to mortality. And so, by this means, comparatively-bad-years tend to be followed by comparatively-good-years, and comparatively-good-years by comparatively-bad-years.</p>
<p>Though this general process is not pleasant to think about or reason through, statistical signals such as the negative <code>AR(1)</code> coefficient identified here tend to keep appearing, whether we are looking for them or not.</p>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<p>In this post we’ve both concluded the time series subseries, and returned to and expanded on a few posts earlier in the series. This includes the very first post, where we were first introduced to the <code>grandmother formulae</code>, the posts on statistical modelling using both frequentist and Bayesian methods, and a substantive post linking life expectancy with economic growth.</p>
<p>Although we’ve now first encountered multivariate regression models in the context of time series, they are a much more general phenomenon. Pretty much any type of model we can think of and apply in a univariate fashion - where <span class="math inline">\(Y\)</span> has just a single column - can conceivably be expanded to two mor more columns, leading to their more complicated multiple regression variants.</p>
</section>
</section>
<section id="whats-missing" class="level2">
<h2 class="anchored" data-anchor-id="whats-missing">What’s missing?</h2>
<p>In choosing to focus on the ARIMA modelling specification, we necessarily didn’t cover some other approaches to time series. This is similar to our series on causal inference, which stuck largely to one of the two main frameworks for thinking about the problems of causal inference - Rubin’s Missing Data framework - and only gave some brief coverage and attempt at consiliation of the other framework - the Pearlean graph-based framework - in the final post.</p>
<p>So, like the final post of the Causal Inference series, let’s discuss a couple of key areas that I’ve not covered in the series so far: state space models; and demographic models.</p>
<section id="state-space-models-and-ets" class="level3">
<h3 class="anchored" data-anchor-id="state-space-models-and-ets">State Space Models and ETS</h3>
<p>Borrowing concepts from control theory - literally rocket science! - and requiring an unhealthy level of knowledge of linear algebra to properly understand and articulate, state space models represent a 1990s statistical formalisation of - mainly - a series of model specifications first developed in the 1950s. In this sense they seem to bookend ARIMA model specifications, which were first developed in the 1970s. The 1950s models were based around the concept of exponential smoothing: the past influences the present, but the recent past influences the present more than the distant past. <a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a></p>
<p>State space models involve solving (or getting a computer to solve) a series of simultaneous equations that link observed values over time <span class="math inline">\(y_t\)</span> to a series of largely unobserved and unobservable model parameters. The key conceptual link between state space models and control theory is that these observed parameters are allowed to change/evolve over time, in response to the degree of error between predicted and observed values at different points in time.</p>
<p>To conceptualise what’s going on, think of a rocket trying to hit another moving target: the target the rocket’s guidance system is tracking keeps changing, as does the position of the rocket relative to its target. So, the targetting parameters used by the rocket to ensure it keeps track of the target need to keep getting updated too. And more recent observations of the target’s location are likely to be more important to determining where the rocket should move, and so how its parameters should be updated, than older observations. Also, the older observations are already in a sense incorporated into the system, as they influenced past decisions about the rocket’s parameters, and so its trajectory in the past, and so its current position. So, given the rocket’s current position, the most recent target position may be the only information needed, now, to decide how much to update the parameters.</p>
<p>To add <a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a> to the analogy (which in some use-cases may have not been an analogy), we could imagine having some parameters which determine how quickly or slowly other parameters get updated. Think of a dial that affects the stiffness of another dial: when this first dial is turned down, the second dial can be moved clockwise or counterclockwise very quickly in response to the moving target; when the first dial is turned up, the second dial is more resistant to change, so takes longer to turn: this is another way of thinking about what exponential smoothing means in practice. There’s likely to be a sweet spot when it comes to this first type of dial: too stiff is bad, as it means the system takes a long time to adjust to the moving target; but too responsive is bad too, as it means the system could become very unstable very quickly. Both excess stiffness and excess responsiveness can contribute to the system (i.e.&nbsp;our model predictions) getting further and further away from its target, and so to greater error.</p>
<p>In practice, with the excellent packages associated with <a href="https://otexts.com/fpp3/ets-estimation.html">Hyndman and Athanasopoulos’s excellent Forecasting book</a>, we can largely ignore some of the more technical aspects of using state space models for time series forecasting with exponential smoothing, and just think of such models by analogy with ARIMA models, as model frameworks with a number of parameters to either select, or use heuristic or algorithmic methods to select for us. With ARIMA with have three parameters: for autoregression (<code>p</code>), differencing (<code>d</code>), and moving average (<code>q</code>); and with Seasonal ARIMA each of these receives a seasonal pair: <code>p</code> pairs with its seasonal analogue, <code>P</code>; <code>d</code> pairs with its seasonal analogue <code>D</code>; and <code>q</code> with its seasonal analogue <code>Q</code>.</p>
<p>The exponential smoothing analogue of the ARIMA framework is known as ETS, which stands for error-trend-season. Just as ARIMA model frameworks take three ‘slots’ - an <code>AR()</code> slot, an <code>I()</code> slot, and a <code>MA()</code> slot - ETS models also have three slots to be filled. However, these three slots don’t take numeric values, but <a href="https://otexts.com/fpp3/taxonomy.html">the following arguments</a>:</p>
<ul>
<li>The error slot <code>E()</code>: takes <code>N</code> for ‘none’, <code>A</code> for ‘additive’, or <code>M</code> for ‘multiplicative’</li>
<li>The trend slot <code>T()</code>: takes <code>N</code> for ‘none’, <code>A</code> for ‘additive’, or <code>A_d</code> for ‘additive-damped’</li>
<li>The seasonal slot <code>S()</code>: takes <code>N</code> for ‘none’, <code>A</code> for ‘additive’, or <code>M</code> for ‘multiplicative’.</li>
</ul>
<p>So, regardless of their different backgrounds, we can use ETS models as an alternative to, and in a very similar way to, ARIMA and SARIMA models.<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a></p>
</section>
<section id="demographic-forecasting-models" class="level3">
<h3 class="anchored" data-anchor-id="demographic-forecasting-models">Demographic forecasting models</h3>
<p>Another (more niche) type of forecasting model I’ve not covered in this series are those used in demographic forecasting, such as the <a href="https://en.wikipedia.org/wiki/Lee%E2%80%93Carter_model">Lee-Carter model</a> specification and its derivatives. When forecasting life expectancy, we could simply model life expectancy directly… or we could model each of its components together: the mortality rates at each specific year of age, and then derive future life expectancies from what the forecast age specific life expectancies at different ages imply the resultant life expectancy should be (i.e.&nbsp;perform a life table calculation on the projected/forecast values for a given future year, much as we do for observed data). This is our second example of multivariate regression, which we were first introduced to earlier. However, Lee-Carter style models can involve projecting forward dozens, if not over a hundred, response values at the same time, whereas in the VAR model example we just had two response values.</p>
<p>Lee-Carter style models represent an intersection between forecasting and factor analysis, due to the way the observed values of many different age-specific mortality rates are assumed to be influenced by, and provide information that can inform, an underlying latent variable known as the drift parameter. Once (something like) factor analysis is used to determine this drift parameter, the (logarithm of the) mortality rates at each specific age are assumed to follow this drift approximately, subject to some random variation, meaning the time series specification they follow is random-walk-with-drift (RWD), which (I think) is an ARIMA(0, 1, 0) specification. This assumption of a single underlying latent drift parameter influencing all ages has <a href="https://gking.harvard.edu/files/abs/lc-abs.shtml">been criticised as perhaps too strong a structural assumption, leading both to the suggestion that each age-specific mortality rate should be forecast independently with RWD</a>, or that the Lee-Carter assumptions implicit in its specification be relaxed in a more piecemeal fashion, leading to some of the alternative longevity forecasting models summarised and evaluated in <a href="https://www.demographic-research.org/volumes/vol15/9/15-9.pdf">this paper</a>, and <a href="https://www.actuaries.org/AFIR/Colloquia/Rome2/Cairns_Blake_Dowd.pdf">this paper</a>.</p>
<p>The overlap between general time series and demographic forecasting is less tenuous than it might first appear, when you consider that one of the authors of the first of the two papers above is none other than Rob Hyndman, whose forecasting book I’ve already referenced and made use of many times in this series. Hyndman is also the maintainer of R’s <a href="https://cran.r-project.org/web/packages/demography/demography.pdf"><code>demography</code> package</a>. So, much of what can be learned about time series can be readily applied to demography too.</p>
<p>Finally, demographic forecasting models in which age-specific mortality over time is modelled open up another way of thinking about the problem: that of spatial statistics. Remember that with exponential smoothing models the assumed information value of models declines exponentially with time? As mentioned in an earlier footnote this is largely what’s known as <a href="https://en.wikipedia.org/wiki/Tobler%27s_first_law_of_geography">Tobler’s First Law of Geography</a>, but applied to just a single dimension (time) rather than two spatial dimensions such as latitude and longitude. Well, with spatial models there are two spatial dimensions, both of which have the same units (say, metres, kilometres, etc). Two points can be equally far apart, but along different spatial dimensions. Point B could be 2km east of point A, or 2km north of point A, or 2km north-east of point A.<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a> In each case, the distance between points is the same, and so the amount of downweighting of the information value of point B as to the true value of point A would be the same.</p>
<p>Well, with the kind of data used by Lee-Carter style models, we have mortality rates that are double indexed: <span class="math inline">\(m_{x,t}\)</span>, where <span class="math inline">\(x\)</span> indexes the age in years, and <span class="math inline">\(t\)</span> indexes the time in years. Note the phrase <em>in years</em>: both age and time are in the same unit, much as latitude and longitude are in the same unit. So it makes sense to think of two points on the surface - <span class="math inline">\(m_{a,b}\)</span> and <span class="math inline">\(m_{c,d}\)</span> - as being a known distance apart from each other,<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a> and so for closer observations to be more similar or informative about each other than more distant values. This kind of as-if-spatial reasoning leads to thinking about how a surface of mortality rates might be smoothed appropriately, with estimates for each point being a function of the observed value of that point, plus some kind of exponentially weighted average of more and less proximately neighbouring points. (See, for example, <a href="https://gking.harvard.edu/files/abs/smooth-abs.shtml">Girosi &amp; King’s framework</a>)</p>
</section>
<section id="summing-up-3" class="level3">
<h3 class="anchored" data-anchor-id="summing-up-3">Summing up</h3>
<p>In this last post, we’ve scratched the surface on a couple of areas related to time series that the main post series didn’t cover: state space modelling and demographic forecasting models. Although hopefully we can agree that they’re both interesting topics, they’ve also helped to illustrate why the main post series has been anchored around the ARIMA modelling framework. Time series is a complex area, and so by sticking with ARIMA, we’ve managed to avoid getting too far adrift.</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Which is also the default, so not strictly necessary this time.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Two further things to note: Firstly, that if there were more than one observational unit <code>i</code> then the data frame should be grouped by the observational unit, then arranged by time. Secondly, that because the first time unit has no time unit, its lagged value is necessarily missing, hence <code>NA</code>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Or equivalently and more commonly summing up the log of these numbers<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>This is in some ways a bad example, as influenza is of course highly seasonal, and one flu episode may be negatively predictive of another flu episode in the same season. But I’m going with it for now…<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Hurray! We’ve demonstrated something we should know from school, namely that if <span class="math inline">\(y = \alpha + \beta x\)</span>, then <span class="math inline">\(\frac{\partial y}{\partial x} = \beta\)</span>.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>The information appears to be ‘overdeterimined’, as one of the metadata fields should be inferrable given the other pieces of information. I suspect this works as something like a ‘checksum’ test, to ensure the data are as intended.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Autoregressive terms <code>p</code> can be included as part of non-stationary series, and there can be an arbitrary number of differencing operations <code>d</code>, but the moving average term <code>q</code> is only suitable for stationary series. So, for example, ARIMA(1,0,0) with drift can be possible, as can ARIMA(1,1,0) with drift, but ARIMA(0,0, 1) with drift is not a legitimate specification.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>Occasionally, we might also see repeated patterns over non-annual timescales. For example, we might see the apparent population size of a country shifting abruptly every 10 years, due to information from national censuses run every decade being incorporated into the population estimates. Or if we track sales by day we might see a weekly cycle, because trade during the weekends tends to be different than during the weekdays.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>How this works is due to the acronym-in-the-acronym: LOESS, meaning <em>local estimation</em>. Effectively for each data point a local regression slope is calculated based on values a certain number of observations ahead and behind the value in question. The number of values ahead and behind considered is the ‘window’ size.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>Sometimes <code>m</code> is used instead of S.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>A primary aim extracting these components from a linear regression in this way is to allow something approximating a Bayesian posterior distribution of coefficients to be generated, using a multivariate normal distribution (the first place we actually encountered a multivariate regression), without using a Bayesian modelling approach. This allows for the estimating and propagation of ‘honest uncertainty’ in predicted and expected outcomes. However, as we saw in <a href="../../../pages/main-course/complete-simulation-example/index.html">the main course</a>, it can sometimes be as or more straightforward to just use a Bayesian modelling approach.<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>i.e.&nbsp;two times three squared.<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13"><p>In some ways, this idea seems equivalent to Tobler’s First Law of Geography, but applied to temporal rather than spatial distance.<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn14"><p>Possibly confusion<a href="#fnref14" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn15"><p>A complicating coda to this is that state space modelling approaches can also be applied to ARIMA models.<a href="#fnref15" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn16"><p>Using a little trigonometry, this would be about 1.41 km east of point A, and 1.41km north of point A.<a href="#fnref16" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn17"><p>Again, a little trigomometry tells us that the Cartesian distance between two points <span class="math inline">\(m_{a,b}\)</span> and <span class="math inline">\(m_{c,d}\)</span> should be <span class="math inline">\(d = \sqrt{(c-a)^2 + (d-b)^2}\)</span>. In practice with spatial statistics two elements are often encoded in terms of adjacency: <code>1</code> if two elements are contiguous (next to each other); <code>0</code> if they are not.<a href="#fnref17" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>